<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nesti — Plateforme Familiale Inclusive (Pro One-File Extended)</title>
  <meta name="description" content="Prototype professionnel tout-en-un : dashboard familial, calendrier, tâches, chat IA, inclusion, RGPD — sans dépendances externes."/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Manrope:wght@600;800&display=swap" rel="stylesheet">
  <style>
    /* ==========================
       THEME & VARIABLES (Design pro, extended)
       ========================== */
    :root{
      --bg: #f4fbff;
      --card: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --glass: rgba(255,255,255,0.7);
      --primary: #136bb1;
      --primary-2: #1c9dea;
      --accent: #ffd166;
      --success: #29c48a;
      --danger: #ff6b6b;
      --radius-xl: 18px;
      --radius-lg: 12px;
      --shadow-soft: 0 6px 28px rgba(17, 102, 204, 0.08);
      --shadow-strong: 0 12px 48px rgba(17, 102, 204, 0.12);
      --mono: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --transition: 220ms cubic-bezier(.2,.9,.27,1);
      --max-width: 1180px;
      --ui-z: 1000;
    }
    /* Dark mode support toggle via [data-theme="dark"] on body */
    body { margin:0; font-family:var(--mono); background:linear-gradient(180deg,#f8fdff 0%,var(--bg) 100%); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    [data-theme="dark"]{ --bg:#071320; --card:#0b1622; --muted:#93a6bd; --text:#f4f8fb; --glass: rgba(10,18,28,0.55); --shadow-soft: 0 10px 30px rgba(0,0,0,0.6); --shadow-strong: 0 18px 50px rgba(0,0,0,0.7); }
    .app { display:flex; min-height:100vh; align-items:stretch; justify-content:flex-start; }
    /* ==========================
       SIDEBAR
       ========================== */
    .sidebar { width:300px; padding:32px 22px; background:linear-gradient(180deg, var(--glass), rgba(255,255,255,0.45)); border-top-right-radius:var(--radius-xl); border-bottom-right-radius:var(--radius-xl); box-shadow:var(--shadow-soft); display:flex; flex-direction:column; gap:22px; }
    [data-theme="dark"] .sidebar{ background:linear-gradient(180deg,var(--glass), rgba(255,255,255,0.02)); }
    .logo { display:flex; align-items:center; gap:12px; }
    .logo svg { width:46px; height:46px; border-radius:9px; }
    .brand { font-weight:800; font-size:1.6rem; color:var(--primary-2); }
    .nav { display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .nav button { background:none; border:none; text-align:left; padding:12px 14px; border-radius:10px; display:flex; gap:12px; align-items:center; cursor:pointer; font-weight:600; color:var(--muted); transition:all var(--transition); }
    .nav button:hover, .nav button:focus { transform:translateX(4px); color:var(--primary-2); box-shadow:var(--shadow-soft); }
    .nav button.active { background:linear-gradient(90deg, rgba(28,157,234,0.12), rgba(255,209,102,0.06)); color:var(--primary-2); }
    .spacer { flex:1; }
    .profile { display:flex; gap:12px; align-items:center; padding-top:12px; border-top:1px solid rgba(0,0,0,0.04); }
    .avatar { width:48px; height:48px; border-radius:10px; background:linear-gradient(180deg,#fff,#f0f8ff); border:1px solid rgba(0,0,0,0.04); background-size:cover; background-position:center; }
    .profile .meta { display:flex; flex-direction:column; }
    .role { font-size:0.9rem; color:var(--muted); }
    .logout { margin-left:auto; background:none; border:none; color:var(--primary); cursor:pointer; font-weight:700; }
    /* ==========================
       MAIN LAYOUT
       ========================== */
    .main { flex:1; padding:42px; display:flex; justify-content:center; }
    .container { width:100%; max-width:var(--max-width); display:grid; grid-template-columns: 1.1fr 2fr 1fr; gap:28px; align-items:start; }
    .header { grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; gap:18px; margin-bottom:6px; }
    .header-left { display:flex; flex-direction:column; gap:6px; }
    .title { font-size:2.2rem; font-weight:800; }
    .subtitle { color:var(--muted); font-weight:600; }
    .header-right { display:flex; gap:12px; align-items:center; }
    .search { border-radius:12px; padding:10px 12px; border:1px solid var(--shadow-soft); background:var(--card); min-width:260px; display:flex; align-items:center; gap:10px; }
    .search input { border:none; outline:none; background:transparent; font-weight:600; width:100%; }
    .cta { background:var(--accent); padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; border:none; box-shadow:var(--shadow-soft); }
    /* ==========================
       CARDS / PANELS
       ========================== */
    .card { background:var(--card); border-radius:var(--radius-lg); padding:20px; box-shadow:var(--shadow-soft); }
    .card h3 { margin:0 0 12px 0; font-size:1.05rem; font-weight:800; }
    .calendar { display:flex; flex-direction:column; gap:10px; }
    .mini-cal { border-radius:10px; padding:12px; background:linear-gradient(180deg, rgba(20,130,200,0.02), rgba(255,255,255,0.02)); }
    .events { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .event-item { display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.4), rgba(255,255,255,0.2)); border-left:6px solid var(--primary); }
    .event-meta { display:flex; flex-direction:column; }
    .event-time { font-weight:800; color:var(--muted); font-size:0.95rem; }
    .event-title { font-weight:800; }
    .event-note { color:var(--muted); font-size:0.9rem; }
    /* TASKS */
    .tasks-list { display:flex; flex-direction:column; gap:10px; }
    .task-row { display:flex; align-items:center; gap:12px; padding:9px; border-radius:10px; border:1px solid rgba(0,0,0,0.03); }
    .task-title { flex:1; font-weight:700; }
    .task-meta { color:var(--muted); font-size:0.9rem; }
    .chip { padding:6px 10px; border-radius:999px; background:linear-gradient(90deg,#fff, rgba(0,0,0,0.02)); font-weight:700; }
    /* CHAT */
    .chat { display:flex; flex-direction:column; gap:12px; height:100%; }
    .chat-list { display:flex; flex-direction:column; gap:10px; max-height:360px; overflow:auto; padding-right:8px; }
    .bubble { display:inline-block; padding:10px 14px; border-radius:14px; max-width:78%; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.04); }
    .bubble.me { background:linear-gradient(90deg,#e7f6ff,#e9f6ff); margin-left:auto; }
    .bubble.bot { background:linear-gradient(90deg,#fff7e6,#fff8e9); margin-right:auto; }
    .chat-input { display:flex; gap:10px; align-items:center; }
    .chat-input input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.05); background:var(--card); font-weight:700; }
    .chat-actions button { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
    .rephrase { background:var(--primary-2); color:#fff; }
    /* ACCESSIBILITY / SETTINGS */
    .controls { display:flex; gap:10px; align-items:center; }
    .toggle { display:inline-flex; align-items:center; gap:8px; cursor:pointer; }
    .switch { width:42px; height:24px; border-radius:999px; background:#e6eefb; position:relative; padding:3px; transition:background var(--transition); }
    .switch .dot { width:18px; height:18px; border-radius:50%; background:#fff; position:absolute; left:3px; top:3px; transition:left var(--transition); box-shadow:var(--shadow-soft); }
    .switch.on { background:linear-gradient(90deg,var(--primary-2),var(--accent)); }
    .switch.on .dot { left:21px; }
    /* OVERLAYS / MODALS */
    .overlay { position:fixed; inset:0; background:rgba(2,6,23,0.55); display:flex; align-items:center; justify-content:center; z-index:var(--ui-z); }
    .modal { background:var(--card); border-radius:14px; padding:22px; width:min(880px,92vw); box-shadow:var(--shadow-strong); }
    .modal h2 { margin:0 0 12px 0; font-size:1.3rem; }
    .modal .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .modal .actions { display:flex; gap:12px; margin-top:12px; }
    /* FOOTER SMALL PRINT */
    .foot { text-align:center; color:var(--muted); margin-top:26px; font-size:0.9rem; }
    /* RESPONSIVE */
    @media (max-width:1100px){
      .container { grid-template-columns:1fr; }
      .sidebar { display:none; }
      .main { padding:20px; }
    }
    /* UTILITY */
    .hidden { display:none !important; }
    .muted { color:var(--muted); }
    .mt { margin-top:14px; }
    .mb { margin-bottom:14px; }
    .frow { display:flex; gap:12px; align-items:center; }
    .pill { padding:6px 10px; border-radius:999px; background:rgba(0,0,0,0.03); font-weight:700; cursor:pointer; border:none; }
    /* simple accessible focus */
    button:focus, input:focus, select:focus { outline:3px solid rgba(28,157,234,0.18); outline-offset:2px; }
    /* KEYBOARD HINT */
    .kbd { border:1px solid rgba(0,0,0,0.06); padding:4px 8px; border-radius:6px; font-weight:700; background:rgba(0,0,0,0.02); }
  </style>
</head>
<body>
  <div id="root" class="app" role="application" aria-label="Nesti Platform"></div>

  <!-- Template for initial UI (injected by JS) -->
  <template id="app-template">
    <aside class="sidebar" role="navigation" aria-label="Menu principal">
      <div class="logo" id="sidebar-logo" tabindex="0">
        <!-- svg brand -->
        <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
          <defs>
            <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0" stop-color="#1c9dea"/>
              <stop offset="1" stop-color="#ffd166"/>
            </linearGradient>
          </defs>
          <rect width="64" height="64" rx="12" fill="url(#g1)"></rect>
          <g transform="translate(8,12)">
            <circle cx="16" cy="14" r="14" fill="#fff"/>
            <ellipse cx="17" cy="19" rx="9" ry="6" fill="#ffd166"/>
            <circle cx="24" cy="14" r="1.8" fill="#222b45"/>
          </g>
        </svg>
        <div class="brand">Nesti</div>
      </div>

      <nav class="nav" id="nav" aria-label="Navigation principale">
        <!-- JS injects nav buttons -->
      </nav>

      <div class="spacer" aria-hidden="true"></div>

      <div class="profile" id="profile">
        <div class="avatar" id="profile-avatar" role="img" aria-label="Photo du profil"></div>
        <div class="meta">
          <div id="profile-name" style="font-weight:800;">Nom</div>
          <div class="role" id="profile-role">Role</div>
        </div>
        <button class="logout" id="logout" title="Se déconnecter" aria-label="Se déconnecter">→</button>
      </div>
    </aside>

    <main class="main" id="main">
      <div class="container" id="container">
        <header class="header" role="banner">
          <div class="header-left">
            <div class="title" id="title">Bonjour, utilisateur</div>
            <div class="subtitle">Organisation et bien-être pour toute la famille</div>
          </div>
          <div class="header-right">
            <div class="search" role="search" aria-label="Recherche">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#1c9dea" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="11.5" cy="11.5" r="5.5" stroke="#1c9dea" stroke-width="1.6"></circle></svg>
              <input id="search-input" placeholder="Rechercher événement, tâche, message..." aria-label="Rechercher">
            </div>
            <div class="controls">
              <div class="toggle" title="Mode sombre">
                <div id="dark-switch" class="switch" role="button" tabindex="0" aria-pressed="false" aria-label="Basculer mode sombre">
                  <div class="dot"></div>
                </div>
              </div>
              <button class="cta" id="new-event-cta" aria-haspopup="dialog">+ Nouveau</button>
            </div>
          </div>
        </header>

        <!-- Left column: calendar + tasks compact -->
        <section class="card" id="left-col" aria-labelledby="left-heading">
          <h3 id="left-heading">Emploi du temps</h3>
          <div class="calendar">
            <div class="mini-cal" id="mini-cal" aria-hidden="false"></div>
            <div class="events" id="today-events" aria-live="polite"></div>
          </div>

          <div class="mt">
            <h3>Liste de tâches</h3>
            <div class="tasks-list" id="task-list"></div>
            <div class="mt frow">
              <input id="new-task-input" placeholder="Nouvelle tâche..." aria-label="Nouvelle tâche" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);">
              <button id="add-task-btn" class="pill" aria-label="Ajouter une tâche">Ajouter</button>
            </div>
          </div>
        </section>

        <!-- Middle column: chat, AI summary -->
        <section class="card" id="center-col" aria-labelledby="center-heading">
          <h3 id="center-heading">Chat familial <span class="chip" id="chat-status">IA active</span></h3>
          <div class="chat" id="chat">
            <div class="chat-list" id="chat-list" role="log" aria-live="polite"></div>
            <div class="chat-input">
              <input id="chat-input" placeholder="Écrire un message..." aria-label="Écrire un message">
              <div class="chat-actions" role="group" aria-label="Actions chat">
                <button id="send-btn" class="pill">Envoyer</button>
                <button id="rephrase-btn" class="rephrase" title="Proposer reformulations">Reformuler</button>
                <button id="variants-btn" class="pill" title="Voir variantes">Variantes</button>
                <button id="summarize-btn" class="pill" title="Résumé conversation">Résumer</button>
              </div>
            </div>
          </div>

          <div class="mt">
            <h3>Résumé & Suggestions IA</h3>
            <div id="ai-suggestions" class="muted">L'assistant peut reformuler, proposer activités inclusives et résumer les conversations.</div>
            <div id="ai-variants" class="mt hidden"></div>
          </div>
        </section>

        <!-- Right column: activities, well-being -->
        <aside class="card" id="right-col" aria-labelledby="right-heading">
          <h3 id="right-heading">Activités inclusives</h3>
          <div id="activities" class="mt"></div>

          <div class="mt">
            <h3>Votre bien-être</h3>
            <div class="muted">Courtes activités, guides et rappels pour la famille</div>
            <div class="mt">
              <button id="start-meditation" class="pill">Démarrer méditation</button>
            </div>
          </div>

          <div class="mt">
            <h3>Paramètres rapides</h3>
            <div class="frow mt">
              <label for="easy-read" class="muted">Lecture facile</label>
              <div style="margin-left:auto;" class="toggle"><div id="easy-switch" class="switch" role="button" tabindex="0" aria-pressed="false"><div class="dot"></div></div></div>
            </div>
            <div class="frow mt">
              <label class="muted">Confidentialité</label>
              <button id="privacy-btn" class="pill" style="margin-left:auto;">Voir</button>
            </div>
            <div class="frow mt">
              <label class="muted">Importer JSON</label>
              <input id="import-file" type="file" accept=".json" style="margin-left:auto;">
            </div>
          </div>
        </aside>

        <!-- Footer / legal -->
        <div class="card" style="grid-column:1/-1;margin-top:18px;">
          <div class="frow" style="justify-content:space-between; align-items:center;">
            <div class="muted">© Nesti — Prototype. Données techniques et d'intégration disponibles pour threading backend.</div>
            <div class="frow">
              <button id="export-data" class="pill">Exporter données</button>
              <button id="export-csv" class="pill">Export tasks CSV</button>
              <button id="delete-account" class="pill" style="background:var(--danger); color:#fff;">Demander suppression</button>
            </div>
          </div>
        </div>

      </div>
    </main>
  </template>

  <!-- MODAL ROOT -->
  <div id="modal-root" aria-live="assertive" style="z-index:2000;position:fixed;inset:0;pointer-events:none;"></div>

  <!-- NOTIFICATION BANNER -->
  <div id="notif-banner" aria-hidden="true" style="position:fixed;right:20px;bottom:20px;z-index:2100;padding:12px 18px;border-radius:10px;background:var(--success);color:#fff;font-weight:800;display:none;box-shadow:var(--shadow-strong)"></div>

  <script>
  /* ==========================
     EXTENDED PROFESSIONAL SINGLE-FILE APP
     - Modular comments, many features
     - No external deps 
     - Local persistence + import/export + CSV
     - IA heuristics: multi-variants rephrase, summarize, moderation
     - Role-based UI and permission checks
     - Keyboard shortcuts: N new event (n), T new task (t), M meditate (m), / focus search
     - Test harness (basic)
     ========================== */

  /* --------------------------
     Small helpers
     -------------------------- */
  const $ = s => document.querySelector(s);
  const $all = s => Array.from(document.querySelectorAll(s));
  const nowStr = () => new Date().toISOString();
  const uid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

  /* --------------------------
     Local storage wrapper
     -------------------------- */
  const Store = {
    key: 'nesti_pro_extended_v2',
    read(){
      try {
        const raw = localStorage.getItem(this.key);
        if(!raw) return null;
        return JSON.parse(raw);
      } catch(e){ console.warn('Store.read', e); return null; }
    },
    write(data){
      try { localStorage.setItem(this.key, JSON.stringify(data)); } catch(e){ console.warn('Store.write', e); }
    },
    export(){
      const data = this.read() || {};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'nesti-export-'+(new Date()).toISOString().slice(0,10)+'.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    },
    importFile(file, cb){
      const reader = new FileReader();
      reader.onload = (e)=> {
        try {
          const parsed = JSON.parse(e.target.result);
          cb(null, parsed);
        } catch(err) { cb(err); }
      };
      reader.readAsText(file);
    },
    exportCSVTasks(){
      const data = this.read();
      const tasks = (data && data.tasks) ? data.tasks : [];
      const header = ['id','title','status','assignee','created_at'];
      const csv = [header.join(',')].concat(tasks.map(t => [t.id, `"${t.title.replace(/"/g,'""')}"`, t.status, t.assignee, t.created_at].join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'nesti-tasks-'+(new Date()).toISOString().slice(0,10)+'.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    },
    clear(){ localStorage.removeItem(this.key); }
  };

  /* --------------------------
     Seed: initial demo data
     -------------------------- */
  const SEED = {
    families: [{
      id: 'fam_1', 
      name: 'Famille Demo',
      members: [
        {id:'u_1', name:'Emma', role:'parent1', email:'emma@mail.com', avatar:''},
        {id:'u_2', name:'Louis', role:'parent2', email:'louis@mail.com', avatar:''},
        {id:'u_3', name:'Alice', role:'enfant', email:'alice@mail.com', avatar:''},
        {id:'u_4', name:'Mamie', role:'invite', email:'mamie@mail.com', avatar:''}
      ]
    }],
    events: [
      { id: 'ev_1', title:'Heure du goûter', time:'15:00', day:10, note:'Gâteau au chocolat', creator:'u_1', created_at:nowStr(), color:'#ffd166' },
      { id: 'ev_2', title:'Cours de piano', time:'17:00', day:10, note:'Salle 2', creator:'u_2', created_at:nowStr(), color:'#1c9dea' },
      { id: 'ev_3', title:'Jeux de famille', time:'20:00', day:10, note:'Choisir le jeu', creator:'u_3', created_at:nowStr(), color:'#29c48a' }
    ],
    tasks: [
      { id:'t_1', title:'Acheter du pain', status:'À faire', assignee:'u_1', created_at:nowStr() },
      { id:'t_2', title:'Préparer le goûter', status:'En cours', assignee:'u_2', created_at:nowStr() },
      { id:'t_3', title:'Ranger la chambre', status:'Fait', assignee:'u_3', created_at:nowStr() }
    ],
    chat:[
      {id:'m_1', from:'u_1', text:'Salut à tous! Quelle activité ce soir ?', created_at:nowStr()},
      {id:'m_2', from:'bot', text:"Bonjour! Je peux vous suggérer la dernière expo sur l'art-thérapie à 18h.", created_at:nowStr()}
    ],
    activities: [
      {id:'a_1', title:'Expo sur l'art-thérapie', place:'Musée de l'art moderne', tags:['inclusion','culture'], color:'#ffd166'},
      {id:'a_2', title:'Atelier peinture', place:'Centre culturel', tags:['créatif'], color:'#1c9dea'},
      {id:'a_3', title:'Yoga famille', place:'Maison de quartier', tags:['bien-être'], color:'#29c48a'}  
    ],
    settings: {
      easyRead:false,
      dark:false,
      consent:{ location:false, analytics:false }
    },
    meta:{ created_at: nowStr() }
  };

  /* --------------------------
     App core
     -------------------------- */
  const App = {
    state: {},
    init(){
      // initialize store or seed
      const data = Store.read();
      if(data){
        this.state = data;
      } else {
        this.state = JSON.parse(JSON.stringify(SEED)); // deep copy
        Store.write(this.state);
      }
      // attach template
      const root = document.getElementById('root');
      root.innerHTML = document.getElementById('app-template').innerHTML;
      // expose sections
      this.cache = {
        nav: $('#nav'),
        profileName: $('#profile-name'),
        profileRole: $('#profile-role'),
        profileAvatar: $('#profile-avatar'),
        title: $('#title'),
        miniCal: $('#mini-cal'),
        todayEvents: $('#today-events'),
        taskList: $('#task-list'),
        chatList: $('#chat-list'),
        chatInput: $('#chat-input'),
        newTaskInput: $('#new-task-input'),
        addTaskBtn: $('#add-task-btn'),
        activitiesEl: $('#activities'),
        modalRoot: $('#modal-root'),
        notif: $('#notif-banner')
      };
      // set demo user (first)
      this.currentUser = this.state.families[0].members[0];
      // render UI
      this.bind();
      this.renderAll();
      this.attachKeyboardShortcuts();
      this.runSelfTests(); // basic automated sanity tests
    },
    persist(){ Store.write(this.state); },
    bind(){
      const D = this;
      // render nav  
      this.renderNav();
      // profile
      this.cache.profileName.textContent = this.currentUser.name;
      this.cache.profileRole.textContent = this.roleLabel(this.currentUser.role);
      this.cache.profileAvatar.style.backgroundImage = `url('https://api.dicebear.com/6.x/identicon/svg?seed=${encodeURIComponent(this.currentUser.name)}')`;
      $('#logout').onclick = ()=>{ this.logout(); };
      // controls
      $('#dark-switch').onclick = ()=>{ this.toggleDark(); };
      $('#easy-switch').onclick = ()=>{ this.toggleEasy(); };
      $('#new-event-cta').onclick = ()=>{ this.openEventModal(); };
      $('#add-task-btn').onclick = ()=>{ this.addTaskFromInput(); };
      $('#search-input').oninput = (e)=> this.search(e.target.value);
      $('#export-data').onclick = ()=> { Store.export(); showToast('Export JSON lancé'); };
      $('#export-csv').onclick = ()=> { Store.exportCSVTasks(); showToast('Export CSV t
                                                                          
      /* --- Composants Dashboard --- */
      function renderDashboard() {
        return h('div', {className: 'dashboard animate-in'}, [
          h('header', {className: 'dashboard-header'}, [
            h('div', {className: 'dashboard-welcome'}, [
              h('h1', {}, `Bonjour, ${state.user.name}`),
              h('p', {}, 'Organisation et bien-être pour toute la famille')
            ]),
            renderQuickActions()
          ]),
          h('div', {className: 'dashboard-grid'}, [
            renderCalendarWidget(),
            renderChatWidget(),
            renderWellbeingWidget()
          ]),
          renderActivityFeed()
        ]);
      }
      
      function renderCalendarWidget() {
        return h('section', {className: 'card calendar-widget'}, [
          h('div', {className: 'card-header'}, [
            h('h2', {}, 'Calendrier'),
            h('button', {
              className: 'button button-primary button-sm',
              onClick: () => showModal('newEvent')
            }, '+ Événement')
          ]),
          h('div', {className: 'calendar-grid'}, renderCalendarGrid()),
          h('div', {className: 'calendar-events'}, 
            state.events
              .filter(evt => isToday(evt.date))
              .map(evt => renderEventCard(evt))
          )
        ]);
      }
      
      function renderChatWidget() {
        return h('section', {className: 'card chat-widget'}, [
          h('div', {className: 'card-header'}, [
            h('h2', {}, 'Chat Familial'),
            h('button', {
              className: 'button button-secondary button-sm',
              onClick: () => state.aiHelperActive = !state.aiHelperActive,
              'aria-pressed': state.aiHelperActive
            }, '🤖 IA Helper')
          ]),
          h('div', {className: 'chat-messages', id: 'chat-messages'},
            state.messages.map(msg => renderChatMessage(msg))
          ),
          h('form', {
            className: 'chat-input-form',
            onSubmit: handleChatSubmit
          }, [
            h('input', {
              type: 'text',
              className: 'input chat-input',
              placeholder: 'Votre message...',
              id: 'chat-input'
            }),
            h('button', {
              type: 'submit',
              className: 'button button-primary'
            }, 'Envoyer')
          ])
        ]);
      }
      
      function renderWellbeingWidget() {
        return h('section', {className: 'card wellbeing-widget'}, [
          h('h2', {}, 'Bien-être'),
          h('div', {className: 'wellbeing-stats'}, [
            renderWellbeingStat('Méditation', '15min', 'var(--brand-primary)'),
            renderWellbeingStat('Activités', '3/5', 'var(--brand-accent)'),
            renderWellbeingStat('Humeur', '😊', 'var(--brand-success)')
          ]),
          h('button', {
            className: 'button button-primary button-lg wellbeing-action',
            onClick: startMeditation
          }, [
            h('span', {}, '▶️ Commencer la méditation'),
            h('span', {className: 'button-desc'}, '15 minutes guidées')
          ])
        ]);
      }
      
      /* --- Système IA --- */
      const aiHelper = {
        analyze: (message) => {
          // Analyse basique des sentiments
          const positiveWords = ['merci', 'super', 'génial', 'content', 'heureux'];
          const negativeWords = ['pas', 'non', 'problème', 'difficile', 'impossible'];
          
          const words = message.toLowerCase().split(' ');
          let sentiment = 'neutral';
          
          if (words.some(w => positiveWords.includes(w))) sentiment = 'positive';
          if (words.some(w => negativeWords.includes(w))) sentiment = 'negative';
          
          return {
            sentiment,
            needsReformulation: sentiment === 'negative',
            suggestedActivities: findRelevantActivities(message)
          };
        },
      
        reformulate: (message) => {
          let reformulated = message;
          
          // Remplacements positifs
          const replacements = {
            'impossible': 'challenging',
            'problème': 'situation',
            'difficile': 'demandant un peu plus d\'effort',
            'pas content': 'j\'aimerais améliorer',
            'ne peux pas': 'pourrais avec de l\'aide'
          };
      
          Object.entries(replacements).forEach(([neg, pos]) => {
            reformulated = reformulated.replace(new RegExp(neg, 'gi'), pos);
          });
      
          // Ajouter une touche positive
          if (!reformulated.includes('merci')) {
            reformulated = `Je comprends, ${reformulated}. Voyons comment nous pouvons améliorer cela ensemble.`;
          }
      
          return reformulated;
        },
      
        generateResponse: (message) => {
          const analysis = aiHelper.analyze(message);
          
          if (analysis.needsReformulation) {
            return {
              text: aiHelper.reformulate(message),
              type: 'suggestion',
              activities: analysis.suggestedActivities
            };
          }
      
          return {
            text: 'Je suis là pour vous aider ! 😊',
            type: 'confirmation'
          };
        }
      };
      
      /* --- Gestionnaire d'Événements --- */
      const eventManager = {
        add: (event) => {
          const newEvent = {
            id: Date.now(),
            createdAt: new Date(),
            ...event
          };
          
          state.events.push(newEvent);
          notify(`Événement "${event.title}" ajouté`);
          saveState();
          return newEvent;
        },
      
        update: (id, updates) => {
          const index = state.events.findIndex(e => e.id === id);
          if (index > -1) {
            state.events[index] = {...state.events[index], ...updates};
            notify('Événement mis à jour');
            saveState();
          }
        },
      
        delete: (id) => {
          state.events = state.events.filter(e => e.id !== id);
          notify('Événement supprimé');
          saveState();
        },
      
        getUpcoming: () => {
          const now = new Date();
          return state.events
            .filter(e => new Date(e.date) >= now)
            .sort((a, b) => new Date(a.date) - new Date(b.date));
        }
      };
      
      /* --- Gestionnaire de Tâches --- */
      const taskManager = {
        add: (task) => {
          const newTask = {
            id: Date.now(),
            status: 'todo',
            createdAt: new Date(),
            ...task
          };
          
          state.tasks.push(newTask);
          notify(`Tâche "${task.title}" ajoutée`);
          saveState();
          return newTask;
        },
      
        update: (id, updates) => {
          const index = state.tasks.findIndex(t => t.id === id);
          if (index > -1) {
            state.tasks[index] = {...state.tasks[index], ...updates};
            saveState();
          }
        },
      
        delete: (id) => {
          state.tasks = state.tasks.filter(t => t.id !== id);
          notify('Tâche supprimée');
          saveState();
        },
      
        toggleStatus: (id) => {
          const task = state.tasks.find(t => t.id === id);
          if (task) {
            task.status = task.status === 'done' ? 'todo' : 'done';
            saveState();
          }
        }
      };
      
      /* --- Gestionnaire de Méditation --- */
      const meditationManager = {
        currentSession: null,
        audio: null,
      
        start: async (duration = 15) => {
          if (meditationManager.currentSession) return;
      
          const session = {
            startTime: new Date(),
            duration: duration * 60, // en secondes
            remainingTime: duration * 60,
            paused: false
          };
      
          meditationManager.currentSession = session;
          meditationManager.audio = new Audio('/meditation-background.mp3');
          meditationManager.audio.loop = true;
      
          try {
            await meditationManager.audio.play();
            notify('Session de méditation commencée');
            
            session.timer = setInterval(() => {
              if (!session.paused) {
                session.remainingTime--;
                updateMeditationUI(session);
                
                if (session.remainingTime <= 0) {
                  meditationManager.end();
                }
              }
            }, 1000);
            
          } catch (error) {
            notify('Erreur audio: cliquez pour commencer', 'error');
          }
        },
      
        pause: () => {
          if (!meditationManager.currentSession) return;
          
          meditationManager.currentSession.paused = true;
          meditationManager.audio?.pause();
          notify('Méditation en pause');
        },
      
        resume: () => {
          if (!meditationManager.currentSession) return;
          
          meditationManager.currentSession.paused = false;
          meditationManager.audio?.play();
          notify('Méditation reprise');
        },
      
        end: () => {
          if (!meditationManager.currentSession) return;
          
          clearInterval(meditationManager.currentSession.timer);
          meditationManager.audio?.pause();
          meditationManager.audio = null;
          
          const duration = (new Date() - meditationManager.currentSession.startTime) / 1000;
          state.stats.meditationTime += Math.round(duration / 60);
          
          meditationManager.currentSession = null;
          saveState();
          notify('Session de méditation terminée');
        }
      };
      
      /* --- Gestionnaire de Thème --- */
      const themeManager = {
        init() {
          // Détecter la préférence système
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          this.setTheme(state.theme || (prefersDark ? 'dark' : 'light'));
          
          // Écouter les changements de préférence système
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!state.theme) { // Si pas de préférence utilisateur
              this.setTheme(e.matches ? 'dark' : 'light');
            }
          });
        },
      
        setTheme(theme) {
          state.theme = theme;
          document.documentElement.setAttribute('data-theme', theme);
          saveState();
        },
      
        toggle() {
          this.setTheme(state.theme === 'dark' ? 'light' : 'dark');
        }
      };
      
      /* --- Gestionnaire de Stats --- */
      const statsManager = {
        init() {
          if (!state.stats) {
            state.stats = {
              meditationTime: 0,
              tasksCompleted: 0,
              eventsAttended: 0,
              wellbeingScore: 0
            };
          }
        },
      
        update(type, value) {
          switch(type) {
            case 'meditation':
              state.stats.meditationTime += value;
              break;
            case 'task':
              state.stats.tasksCompleted += value;
              break;
            case 'event':
              state.stats.eventsAttended += value;
              break;
            case 'wellbeing':
              // Moyenne mobile du score de bien-être
              state.stats.wellbeingScore = (state.stats.wellbeingScore * 0.7) + (value * 0.3);
              break;
          }
          saveState();
        },
      
        getReport() {
          return {
            dailyStats: {
              meditation: `${state.stats.meditationTime} min`,
              tasks: `${state.stats.tasksCompleted} complétées`,
              events: `${state.stats.eventsAttended} participations`
            },
            wellbeingTrend: Math.round(state.stats.wellbeingScore * 10) / 10
          };
        }
      };
      
      /* --- Gestionnaire de Données --- */
      const dataManager = {
        async export() {
          const data = {
            events: state.events,
            tasks: state.tasks,
            stats: state.stats,
            settings: {
              theme: state.theme,
              notifications: state.notifications
            }
          };
      
          const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `nesti-export-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        },
      
        async import(file) {
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            // Validation basique
            if (!data.events || !data.tasks || !data.stats) {
              throw new Error('Format de fichier invalide');
            }
      
            // Mise à jour de l'état
            state.events = data.events;
            state.tasks = data.tasks;
            state.stats = data.stats;
            if (data.settings) {
              state.theme = data.settings.theme;
              state.notifications = data.settings.notifications;
            }
      
            saveState();
            notify('Données importées avec succès');
            renderApp();
            
          } catch (error) {
            notify('Erreur lors de l\'import: ' + error.message, 'error');
          }
        }
      };
      
      /* --- Gestionnaire d'Accessibilité --- */
      const a11yManager = {
        init() {
          // Gérer la navigation au clavier
          document.addEventListener('keydown', this.handleKeyboardNav);
          
          // Observer les changements de contenu dynamique
          this.setupLiveRegions();
          
          // Initialiser les préférences d'accessibilité
          this.loadPreferences();
        },
      
        handleKeyboardNav(e) {
          // Raccourcis clavier
          if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
              case 'm':
                e.preventDefault();
                meditationManager.currentSession ? 
                  meditationManager.pause() : 
                  meditationManager.start();
                break;
              case 'b':
                e.preventDefault();
                themeManager.toggle();
                break;
            }
          }
        },
      
        setupLiveRegions() {
          const notifications = document.getElementById('notifications');
          notifications.setAttribute('aria-live', 'polite');
          notifications.setAttribute('role', 'status');
        },
      
        loadPreferences() {
          const prefs = localStorage.getItem('a11yPreferences');
          if (prefs) {
            const { fontSize, highContrast, reduceMotion } = JSON.parse(prefs);
            this.applyPreferences({ fontSize, highContrast, reduceMotion });
          }
        },
      
        applyPreferences({ fontSize, highContrast, reduceMotion }) {
          document.documentElement.style.fontSize = fontSize + 'px';
          
          if (highContrast) {
            document.documentElement.classList.add('high-contrast');
          }
          
          if (reduceMotion) {
            document.documentElement.classList.add('reduce-motion');
          }
        },
      
        savePreferences(prefs) {
          localStorage.setItem('a11yPreferences', JSON.stringify(prefs));
          this.applyPreferences(prefs);
        }
      };
      
      /* --- Initialisation --- */
      function initApp() {
        loadState();
        themeManager.init();
        statsManager.init();
        a11yManager.init();
        renderApp();
      }
      
      function loadState() {
        const saved = localStorage.getItem('nestiState');
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            Object.assign(state, parsed);
          } catch (e) {
            console.error('Erreur de chargement:', e);
          }
        }
      }
      
      function saveState() {
        localStorage.setItem('nestiState', JSON.stringify(state));
      }
      
      /* --- Démarrage de l'application --- */
      initApp();
  </script>
</body>
</html>
