<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Nesti — Plateforme Familiale Inclusive</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Manrope:wght@500;800&display=swap" rel="stylesheet">
  <style>
    /* -- Palette et variables "brand" -- */
    :root {
      --brand-bg-gradient: linear-gradient(120deg, #f5faff 0%, #e3f0fa 100%);
      --brand-glass: rgba(255,255,255,0.7);
      --brand-glass-dark: rgba(34,43,69,0.72);
      --brand-primary: #1c9dea;
      --brand-primary-dark: #136bb1;
      --brand-secondary: #ffe066;
      --brand-secondary-dark: #ffd600;
      --brand-accent: #43e6b5;
      --brand-danger: #f35260;
      --brand-muted: #6a7ba2;
      --brand-card: #fff;
      --brand-card-dark: #232d47;
      --brand-sidebar: #eaf6fb;
      --brand-sidebar-dark: #18223b;
      --brand-gradient: linear-gradient(110deg, #1c9dea 0%, #ffe066 100%);
      --brand-shadow: 0 6px 24px #1c9dea22;
      --brand-shadow-strong: 0 12px 40px #1c9dea33;
      --brand-radius: 20px;
      --brand-border: #e0eaf1;
      --brand-dark: #222b45;
      --brand-light: #f5faff;
      --brand-chat-bg: #eaf6fb;
      --brand-chat-ia: #fffbe6;
      --brand-inclusion: #fff9e7;
      --brand-success: #1fc98c;
      --brand-warning: #f8be40;
      --brand-font-main: 'Manrope', 'Inter', ui-sans-serif, system-ui, sans-serif;
      --brand-font-heading: 'Manrope', 'Inter', ui-sans-serif, system-ui, sans-serif;
      --transition: all 0.25s cubic-bezier(.53,.21,.29,.96);
    }
    html, body, #app {min-height:100vh;}
    html, body {margin:0;padding:0;background:var(--brand-bg-gradient);color:var(--brand-dark);}
    body {font-family:var(--brand-font-main);}
    #app {display:flex;min-height:100vh;}
    /* Sidebar */
    .sidebar {
      width:288px; min-width:200px; background:var(--brand-sidebar);
      box-shadow:2px 0 16px #1c9dea09;
      display:flex; flex-direction:column; padding:44px 28px 30px 28px;
      border-top-right-radius: var(--brand-radius);
      border-bottom-right-radius: var(--brand-radius);
      transition:width 0.3s var(--transition),background 0.3s;
      position:relative; z-index:2;
    }
    .sidebar-logo {display:flex;align-items:center; margin-bottom:58px;}
    .sidebar-logo svg {width:48px; height:48px; margin-right:16px;}
    .sidebar-title {font-weight:800;font-size:2.1rem; color:var(--brand-primary);}
    .sidebar-nav {display:flex; flex-direction:column; gap:19px;}
    .sidebar-nav .nav-item {
      display:flex;align-items:center;gap:15px;
      padding:15px 22px; border-radius:13px; cursor:pointer; font-size:1.18rem;
      color:var(--brand-dark); font-weight:600; transition:background 0.20s, color 0.18s;
      outline:none; border:none; background:none;
    }
    .sidebar-nav .nav-item.active, .sidebar-nav .nav-item:focus, .sidebar-nav .nav-item:hover {
      background:var(--brand-primary); color:#fff; box-shadow:0 2px 8px #1c9dea37;
    }
    .sidebar-profile {
      margin-top:auto; display:flex; align-items:center; gap:15px; padding-top:40px;
      border-top:1px solid var(--brand-border);
      position:relative;
    }
    .avatar {width:54px; height:54px; border-radius:18px; background:#EEE; border:3px solid #cdefff;}
    .sidebar-logout-btn {margin-left:auto;background:none;border:none;color:var(--brand-primary);font-size:1.3em;cursor:pointer;}
    /* Main */
    .main {flex:1; padding:62px 4vw 38px 4vw;}
    .dashboard-header {display:flex;justify-content:space-between;align-items:center;}
    .header-info {max-width:63%;}
    .header-title {font-size:2.7rem;font-weight:800;font-family:var(--brand-font-heading);}
    .header-desc {color:var(--brand-muted);font-size:1.25em;}
    .dashboard-grid {
      display:grid; grid-template-columns:1.1fr 2.2fr 1.1fr; gap:44px; margin-top:38px;
    }
    /* Card */
    .card {
      background:var(--brand-card); border-radius:var(--brand-radius); box-shadow:var(--brand-shadow); 
      padding:32px 30px 26px 30px; margin-bottom:26px;
      transition:box-shadow 0.18s, background 0.18s;
      position:relative; overflow:hidden;
    }
    .card h2, .card h3 {margin-top:0; font-size:1.35rem; font-weight:700;}
    .card .badge {background:var(--brand-primary);color:#fff;font-size:0.89em;border-radius:8px;padding:3px 10px; margin-left:8px;}
    .glass {background:var(--brand-glass); box-shadow:var(--brand-shadow);}
    /* Calendar */
    .calendar-table {width:100%; border-collapse:collapse; text-align:center; margin-bottom:18px;}
    .calendar-table th, .calendar-table td {padding:6px;}
    .calendar-evt {
      display:flex;align-items:center;margin-top:10px;gap:11px;
      font-size:1.08em; background:var(--brand-chat-bg); border-radius:9px; padding:5px 13px; box-shadow:0 1px 4px #1c9dea13;
      transition:background 0.2s;
    }
    .calendar-evt .evt-title {font-weight:700;}
    .calendar-evt .evt-time {font-size:1.02em;margin-right:7px;}
    .calendar-evt .evt-note {font-size:0.92em;color:var(--brand-muted);margin-left:10px;}
    .calendar-add-btn {
      background:var(--brand-primary);color:#fff;border:none; border-radius:10px; font-weight:700;
      padding:7px 17px; cursor:pointer; font-size:1.1em; float:right; margin-bottom:7px; box-shadow:0 2px 8px #1c9dea18;
      transition:background 0.18s;
    }
    .calendar-add-btn:hover {background:var(--brand-primary-dark);}
    .calendar-modal-bg {position:fixed; top:0; left:0; width:100vw; height:100vh; background:#0007; z-index:50; display:flex; align-items:center; justify-content:center;}
    .calendar-modal {background:var(--brand-card); border-radius:21px; padding:34px 36px; min-width:370px; box-shadow:0 12px 40px #1c9dea22;}
    .calendar-modal label {display:block; margin-top:16px; font-weight:700;}
    .calendar-modal input, .calendar-modal textarea, .calendar-modal select {
      width:99%; font-size:1.08em; padding:9px 11px; border-radius:10px; border:1px solid var(--brand-border); margin-top:5px;
      background:var(--brand-bg-gradient);
      font-family:var(--brand-font-main);
    }
    .calendar-modal-actions {display:flex; gap:18px; margin-top:26px;}
    .calendar-modal-actions button {flex:1;padding:11px 0;font-size:1.08em;}
    .calendar-modal-actions .cancel {background:#f0f0f0;}
    .calendar-modal-actions .save {background:var(--brand-primary);color:#fff;}
    /* Tâches */
    .task-list {margin:0;padding:0;list-style:none;}
    .task-li {display:flex;align-items:center;gap:13px; margin-bottom:12px;}
    .task-checkbox {accent-color:var(--brand-primary); width:22px;height:22px;}
    .task-title {flex:1;font-size:1.05em;}
    .task-status {font-size:0.96em; border-radius:7px; padding:3px 11px;}
    .status-pending {background:var(--brand-secondary);}
    .status-todo {background:var(--brand-accent);color:#fff;}
    .status-done {background:var(--brand-success);color:#fff;}
    .task-add-row {display:flex;gap:9px;margin-top:17px;}
    .task-add-inp {flex:1;}
    .task-add-btn {background:var(--brand-secondary); border:none; border-radius:9px; padding:9px 17px; font-weight:700; cursor:pointer;}
    .task-assignee {font-size:0.93em;color:var(--brand-muted);margin-left:10px;}
    /* Chat */
    .chat-list {max-height:205px; overflow-y:auto; margin-bottom:13px;}
    .chat-msg {margin-bottom:13px; padding:13px 17px; border-radius:14px; max-width:70%; font-size:1.05em; word-break:break-word; font-family:var(--brand-font-main);}
    .chat-me {background:var(--brand-chat-bg); align-self:flex-end;}
    .chat-bot {background:var(--brand-chat-ia); align-self:flex-start;}
    .chat-row {display:flex;flex-direction:column;align-items:flex-end;}
    .chat-row.bot {align-items:flex-start;}
    .chat-input-row {display:flex;gap:13px;}
    .chat-inp {flex:1; border:1px solid var(--brand-border); border-radius:10px; padding:11px 15px; font-size:1.05em;}
    .chat-btn {background:var(--brand-secondary); color:var(--brand-dark); border:none; border-radius:10px; padding:11px 21px; font-weight:700; cursor:pointer;}
    .chat-btn:hover {background:var(--brand-secondary-dark);}
    /* Activités */
    .activity-card {background:var(--brand-inclusion); border-radius:14px; padding:18px 24px; margin-bottom:22px; box-shadow:0 2px 10px #ffe06622;}
    .activity-card .act-title {font-size:1.1em;font-weight:800;}
    .activity-card .act-place {color:var(--brand-muted);font-size:0.98em;}
    .activity-card .act-tags {color:var(--brand-accent);font-size:0.97em;margin-top:10px;}
    .wellbeing-card {background:var(--brand-bg-gradient); border-radius:14px; padding:19px 23px; box-shadow:0 2px 10px #1fc98c18;}
    .wellbeing-btn {background:var(--brand-success); border:none; border-radius:9px; padding:9px 19px; font-weight:800; color:#fff; cursor:pointer; margin-top:10px;}
    .wellbeing-btn:hover {background:#14b57a;}
    /* Notifications */
    .notif-banner {
      position:fixed; bottom:22px; left:50%; transform:translateX(-50%);
      background:var(--brand-success); color:#fff; border-radius:15px;
      padding:15px 25px; font-weight:700; box-shadow:0 4px 32px #1fc98c42; z-index:300;
      font-family:var(--brand-font-main);
      font-size:1.12em; display:none;
      animation:fadein 0.25s cubic-bezier(.53,.21,.29,.96);
    }
    @keyframes fadein {from{opacity:0;transform:translateY(60px) scale(0.9);}to{opacity:1;}}
    /* Accessibilité */
    .easyread {font-size:1.25em; letter-spacing:0.025em; background:#fffde8;}
    .easyread .card, .easyread .activity-card, .easyread .wellbeing-card {font-size:1.17em;}
    /* Modal overlay pour charte, privacy, etc */
    .overlay-bg {position:fixed; top:0; left:0; width:100vw; height:100vh; background:#001a; z-index:199; display:flex; align-items:center; justify-content:center;}
    .overlay-content {background:var(--brand-card); border-radius:22px; min-width:370px; max-width:97vw; padding:36px 36px; box-shadow:0 14px 55px #1c9dea33; position:relative;}
    .overlay-content h2 {margin-top:0;}
    .overlay-close {background:none; border:none; font-size:1.55em; position:absolute; top:26px; right:31px; cursor:pointer;}
    /* KPIs, Monitoring, etc */
    .kpi-grid {display:grid;grid-template-columns:repeat(3,1fr);gap:28px;margin-top:30px;}
    .kpi-card {background:var(--brand-card);border-radius:14px;box-shadow:0 2px 10px #1c9dea16;padding:23px 25px;text-align:center;}
    .kpi-title {font-weight:700;color:var(--brand-primary);}
    .kpi-value {font-size:2.2em;font-weight:800;}
    .kpi-desc {color:var(--brand-muted);font-size:0.96em;}
    /* Responsive */
    @media (max-width:1300px) {.dashboard-grid {grid-template-columns:1fr 2.1fr 1fr;}}
    @media (max-width:1100px) {.dashboard-grid {grid-template-columns:1fr;}}
    @media (max-width:900px) {.main {padding:12px 2vw;}}
    @media (max-width:700px) {
      #app {flex-direction:column;}
      .sidebar {width:100vw; flex-direction:row; padding:10px 8px;}
      .sidebar-logo, .sidebar-profile {display:none;}
      .sidebar-nav {flex-direction:row; gap:12px;}
      .main {padding:10px 3vw;}
    }
  </style>
</head>
<body>
<div id="app"></div>
<div class="notif-banner" id="notif-banner"></div>
<script>
/* --- MOCK DATA --- */
const ROLES = ['parent1','parent2','enfant','invite'];
const FAMILIES = [
  {id:1, name:"Famille Demo", members:[
    {id:1, name:"Emma", role:"parent1", email:"emma@mail.com", avatar:"https://www.svgrepo.com/show/427834/avatar-profile.svg"},
    {id:2, name:"Louis", role:"parent2", email:"louis@mail.com", avatar:"https://www.svgrepo.com/show/427839/avatar-profile.svg"},
    {id:3, name:"Alice", role:"enfant", email:"alice@mail.com", avatar:"https://www.svgrepo.com/show/427841/avatar-profile.svg"},
    {id:4, name:"Mamie Jeanne", role:"invite", email:"mamie@mail.com", avatar:"https://www.svgrepo.com/show/427838/avatar-profile.svg"}
  ]}
];
const MOCK_EVENTS = [
  {id:1, title:"Heure du goûter", time:"15:00", day:10, note:"Gâteau au chocolat", creator:1, color:"#ffe066"},
  {id:2, title:"Cours de piano", time:"17:00", day:10, note:"Salle 2", creator:2, color:"#1c9dea"},
  {id:3, title:"Jeux de famille", time:"20:00", day:10, note:"Choisir le jeu", creator:3, color:"#43e6b5"},
  {id:4, title:"RDV Orthophoniste", time:"14:30", day:11, note:"", creator:1, color:"#1fc98c"},
  {id:5, title:"Sortie au parc", time:"11:00", day:12, note:"Prévoir goûter", creator:2, color:"#f35260"}
];
const MOCK_TASKS = [
  {id:1, title:"Acheter du pain", status:"À faire", assignee:1},
  {id:2, title:"Préparer le goûter", status:"En cours", assignee:2},
  {id:3, title:"Ranger la chambre", status:"Fait", assignee:3},
  {id:4, title:"Télécharger l’attestation", status:"À faire", assignee:4}
];
const MOCK_CHAT = [
  {from:1, text:"Salut à tous! Quelle activité ce soir ?"},
  {from:"bot", text:"Bonjour! Je peux vous suggérer la dernière expo sur l’art thérapie à 1h"},
  {from:3, text:"Je veux faire un jeu de société !"},
  {from:"bot", text:"Bonne idée Alice 😊 Voulez-vous que je propose quelques jeux adaptés ?"}
];
const MOCK_ACTIVITIES = [
  {id:1, title:"Expo sur l’art-thérapie", place:"Musée de l’art moderne", age:"all", tags:["inclusion","culture"], color:"#ffe066"},
  {id:2, title:"Atelier peinture", place:"Centre culturel", age:"8+", tags:["créatif"], color:"#1c9dea"},
  {id:3, title:"Spectacle inclusif", place:"Théâtre des enfants", age:"all", tags:["inclusion","spectacle"], color:"#43e6b5"},
  {id:4, title:"Yoga famille", place:"Maison de quartier", age:"all", tags:["bien-être","inclusion"], color:"#1fc98c"}
];
const WELLBEING_MSG = "N’oubliez pas votre pause méditation";
const MOCK_KPIS = [
  {title:"Taux d’activation", value:"73%", desc:"Familles actives ce mois-ci"},
  {title:"Utilisation inclusion", value:"62%", desc:"Fonctionnalités inclusion utilisées"},
  {title:"NPS", value:"8,7", desc:"Satisfaction parents/enfants"}
];
let state = {
  user:null,
  family:null,
  page:"auth",
  events:[...MOCK_EVENTS],
  tasks:[...MOCK_TASKS],
  chat:[...MOCK_CHAT],
  easyread:false,
  overlay:null,
  dark:false
};

/* --- RENDER ROOT --- */
function renderRoot() {
  document.body.className = state.easyread ? "easyread" : "";
  document.getElementById('app').innerHTML = '';
  if(!state.user) return renderAuth();
  renderApp();
}
window.onhashchange = ()=>{ 
  const page = location.hash.replace(/^#\/?/,'');
  if(['dashboard','calendar','tasks','chat','activities','settings'].includes(page)) {
    state.page = page;
    renderRoot();
  }
}

/* --- AUTH --- */
function renderAuth() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="margin:auto;max-width:480px;padding:70px 38px 42px 38px;background:var(--brand-card);border-radius:22px;box-shadow:var(--brand-shadow-strong);position:relative;">
      <div style="display:flex;align-items:center;margin-bottom:34px;">
        <svg width="54" height="54" viewBox="0 0 54 54" fill="none">
          <circle cx="27" cy="27" r="27" fill="#1c9dea"/>
          <ellipse cx="27" cy="31" rx="14" ry="11" fill="#ffe066"/>
          <ellipse cx="25" cy="25" rx="7.5" ry="5.2" fill="#FFF"/>
          <circle cx="30" cy="25" r="1.5" fill="#222B45"/>
          <ellipse cx="32.5" cy="34" rx="4" ry="1.6" fill="#ffd600"/>
        </svg>
        <span style="font-weight:800;font-size:2.2rem;color:var(--brand-primary);margin-left:18px;">Nesti</span>
      </div>
      <h2 style="margin:0 0 19px 0;font-weight:800;font-family:var(--brand-font-heading);">Connectez-vous à votre espace familial</h2>
      <form id="login-form">
        <label style="font-weight:700;">Email</label>
        <input id="login-email" type="email" required placeholder="emma@mail.com" style="width:100%;margin-bottom:24px;padding:13px 13px;border-radius:13px;border:1.5px solid #e0e0e0;font-size:1.15em;">
        <label style="font-weight:700;">Rôle</label>
        <select id="login-role" style="width:100%;margin-bottom:24px;padding:12px 13px;border-radius:12px;border:1px solid #e0e0e0;font-size:1.08em;">
          <option value="parent1">Parent 1</option><option value="parent2">Parent 2</option><option value="enfant">Enfant</option><option value="invite">Invité</option>
        </select>
        <button style="background:var(--brand-primary);color:#fff;width:100%;padding:13px 0;font-weight:800;border:none;border-radius:13px;font-size:1.18em;cursor:pointer;margin-top:10px;">Connexion</button>
      </form>
      <div style="margin-top:26px;font-size:1.05em;">
        <a href="#" onclick="showOverlay('charte');return false;" style="color:var(--brand-primary);font-weight:600;">Voir la charte d'inclusion</a>
      </div>
    </div>
  `;
  document.getElementById('login-form').onsubmit = e => {
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim().toLowerCase();
    const role = document.getElementById('login-role').value;
    const family = FAMILIES[0];
    const user = family.members.find(u=>u.email===email && u.role===role) || family.members.find(u=>u.role===role);
    if(user) {
      state.user = user;
      state.family = family;
      state.page = "dashboard";
      location.hash="#/dashboard";
      renderRoot();
    } else {
      showNotif("Email ou rôle incorrects.");
    }
  }
}

/* --- APP SHELL --- */
function renderApp() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <aside class="sidebar">
      <div class="sidebar-logo">
        <svg viewBox="0 0 54 54" fill="none">
          <circle cx="27" cy="27" r="27" fill="#1c9dea"/>
          <ellipse cx="27" cy="31" rx="14" ry="11" fill="#ffe066"/>
          <ellipse cx="25" cy="25" rx="7.5" ry="5.2" fill="#FFF"/>
          <circle cx="30" cy="25" r="1.5" fill="#222B45"/>
          <ellipse cx="32.5" cy="34" rx="4" ry="1.6" fill="#ffd600"/>
        </svg>
        <span class="sidebar-title">Nesti</span>
      </div>
      <nav class="sidebar-nav">
        ${navItem("dashboard","Dashboard","M17 6V3M7 6V3M3 9h18M4 19h16a1 1 0 001-1V7a1 1 0 00-1-1H4a1 1 0 00-1 1v11a1 1 0 001 1z")}
        ${navItem("calendar","Calendrier","M8 7V3m8 4V3m-9 8h18M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z")}
        ${navItem("tasks","Tâches","M9 12l2 2l4-4m-7 8h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v7a2 2 0 002 2z")}
        ${navItem("chat","Chat","M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z")}
        ${navItem("activities","Activités","M12 8c-1.657 0-3 1.343-3 3c0 1.657 1.343 3 3 3s3-1.343 3-3c0-1.657-1.343-3-3-3zm0 8c-2.21 0-4-1.79-4-4a4 4 0 118 0c0 2.21-1.79 4-4 4zm7-2h5M17 7v14m-2-7h4")}
        ${navItem("settings","Paramètres","M12 8c-1.657 0-3 1.343-3 3c0 1.657 1.343 3 3 3s3-1.343 3-3c0-1.657-1.343-3-3-3zm0 8c-2.21 0-4-1.79-4-4a4 4 0 118 0c0 2.21-1.79 4-4 4zm7-2h5M17 7v14m-2-7h4")}
      </nav>
      <div class="sidebar-profile">
        <img class="avatar" src="${state.user.avatar}" />
        <div style="font-size:1.03em;">
          <div style="font-weight:700;font-family:var(--brand-font-main);">${state.user.name}</div>
          <div style="color:var(--brand-muted);font-size:0.98em;">${roleLabel(state.user.role)}</div>
        </div>
        <button class="sidebar-logout-btn" onclick="logout()" title="Déconnexion">&rarr;</button>
      </div>
    </aside>
    <main class="main" id="main-container"></main>
  `;
  Array.from(document.querySelectorAll('.nav-item')).forEach(item=>{
    item.onclick = ()=>{location.hash="#/"+item.dataset.page;}
  });
  renderPageContent();
}
function navItem(page,label,iconPath) {
  const active = state.page===page ? "active" : "";
  return `<button class="nav-item ${active}" data-page="${page}">
    <svg class="evt-icon" viewBox="0 0 24 24" fill="none" stroke="#1c9dea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${iconPath}"/></svg>
    <span>${label}</span>
  </button>`;
}
function roleLabel(r) {
  return {parent1:"Parent 1",parent2:"Parent 2",enfant:"Enfant",invite:"Invité"}[r]||r;
}
function logout(){ state.user=null; state.family=null; state.page="auth"; location.hash=''; renderRoot(); }

/* --- PAGES --- */
function renderPageContent() {
  let html = "";
  switch(state.page) {
    case "dashboard": html = dashboardPage(); break;
    case "calendar": html = calendarPage(); break;
    case "tasks": html = tasksPage(); break;
    case "chat": html = chatPage(); break;
    case "activities": html = activitiesPage(); break;
    case "settings": html = settingsPage(); break;
    default: html = dashboardPage();
  }
  document.getElementById('main-container').innerHTML = html;
  afterRenderPage();
}
function dashboardPage() {
  return `
    <div class="dashboard-header">
      <div class="header-info">
        <div class="header-title">Bonjour, ${state.user.name}</div>
        <div class="header-desc">Organisation et bien-être pour toute la famille</div>
      </div>
      <img class="avatar" src="${state.user.avatar}" />
    </div>
    <div class="dashboard-grid">
      <section class="card glass">
        <h2>Emploi du temps <span class="badge">aujourd'hui</span></h2>
        <button class="calendar-add-btn" onclick="showOverlay('event')">+</button>
        ${calendarMiniTable()}
        ${state.events.filter(e=>e.day===10).map(evt=>calendarEventLine(evt)).join('')}
      </section>
      <section class="card glass" style="grid-column: span 2;">
        <h2>Chat familial</h2>
        <div id="chat-list" class="chat-list"></div>
        <form class="chat-input-row" id="chat-form" autocomplete="off">
          <input id="chat-input" class="chat-inp" placeholder="Écrire un message..." />
          <button type="submit" class="chat-btn">Envoyer</button>
          <button type="button" class="chat-btn" id="rephrase-btn" title="Reformuler (IA)">🤖</button>
        </form>
      </section>
      <div>
        <div class="activity-card">
          <div class="act-title">${MOCK_ACTIVITIES[0].title}</div>
          <div class="act-place">${MOCK_ACTIVITIES[0].place}</div>
          <div class="act-tags">Tags: ${MOCK_ACTIVITIES[0].tags.join(', ')}</div>
        </div>
        <div class="wellbeing-card">
          <h3 style="margin:0 0 5px 0;">Votre bien-être</h3>
          <div>${WELLBEING_MSG}</div>
          <button class="wellbeing-btn" onclick="showNotif('Bonne méditation !')">Démarrer</button>
        </div>
      </div>
    </div>
    <div class="kpi-grid">
      ${MOCK_KPIS.map(k=>`
        <div class="kpi-card">
          <div class="kpi-title">${k.title}</div>
          <div class="kpi-value">${k.value}</div>
          <div class="kpi-desc">${k.desc}</div>
        </div>
      `).join('')}
    </div>
  `;
}
function calendarPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;">
      <h2 style="font-size:2em;font-weight:800;">Calendrier familial</h2>
      <button class="calendar-add-btn" onclick="showOverlay('event')">Ajouter un événement</button>
    </div>
    <div>
      <table class="calendar-table"><thead>
        <tr><th>Date</th><th>Heure</th><th>Événement</th><th>Note</th><th>Ajouté par</th></tr>
      </thead><tbody>
        ${state.events.map(evt=>`
          <tr>
            <td>${evt.day}/09</td>
            <td>${evt.time}</td>
            <td>${evt.title}</td>
            <td>${evt.note||""}</td>
            <td>${userName(evt.creator)}</td>
          </tr>
        `).join('')}
      </tbody></table>
    </div>
  `;
}
function tasksPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;">
      <h2 style="font-size:2em;font-weight:800;">Liste de tâches</h2>
    </div>
    <ul class="task-list">
      ${state.tasks.map(t=>`
        <li class="task-li">
          <input class="task-checkbox" type="checkbox" ${t.status==="Fait"?"checked":""} onchange="toggleTaskStatus(${t.id})"/>
          <span class="task-title">${t.title}</span>
          <span class="task-status ${statusClass(t.status)}">${t.status}</span>
          <span class="task-assignee">${userName(t.assignee)}</span>
          <button onclick="deleteTask(${t.id})" style="background:none;border:none;color:var(--brand-danger);font-size:1.2em;cursor:pointer;">×</button>
        </li>
      `).join('')}
    </ul>
    <div class="task-add-row">
      <input id="task-add-inp" class="task-add-inp" placeholder="Nouvelle tâche à ajouter..." />
      <select id="task-add-user">
        ${state.family.members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('')}
      </select>
      <button class="task-add-btn" onclick="addTask()">Ajouter</button>
    </div>
  `;
}
function chatPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;">
      <h2 style="font-size:2em;font-weight:800;">Chat familial</h2>
    </div>
    <div id="chat-list" class="chat-list"></div>
    <form class="chat-input-row" id="chat-form" autocomplete="off">
      <input id="chat-input" class="chat-inp" placeholder="Écrire un message..." />
      <button type="submit" class="chat-btn">Envoyer</button>
      <button type="button" class="chat-btn" id="rephrase-btn" title="Reformuler (IA)">🤖</button>
    </form>
  `;
}
function activitiesPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;">
      <h2 style="font-size:2em;font-weight:800;">Activités inclusives & recommandations</h2>
      <button onclick="showOverlay('charte')" style="background:var(--brand-secondary);border:none;padding:11px 23px;border-radius:10px;font-weight:800;font-size:1.05em;cursor:pointer;">Charte inclusion</button>
    </div>
    <div>
      ${MOCK_ACTIVITIES.map(a=>`
        <div class="activity-card" style="border-left:7px solid ${a.color};">
          <div class="act-title">${a.title}</div>
          <div class="act-place">${a.place}</div>
          <div class="act-tags">Tags: ${a.tags.join(', ')}</div>
        </div>
      `).join('')}
    </div>
  `;
}
function settingsPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;">
      <h2 style="font-size:2em;font-weight:800;">Paramètres</h2>
    </div>
    <div class="card" style="margin-bottom:24px;">
      <label style="display:flex;align-items:center;gap:15px;font-size:1.11em;">
        <input type="checkbox" id="easyread-toggle" ${state.easyread?"checked":""} onchange="toggleEasyRead()" />
        Activer le mode « lecture facile » (accessibilité)
      </label>
    </div>
    <div class="card">
      <h3>Confidentialité et données</h3>
      <button onclick="showOverlay('privacy')" style="background:var(--brand-primary);color:#fff;font-size:1.12em;border:none;padding:11px 23px;border-radius:10px;font-weight:800;cursor:pointer;">Voir la politique</button>
      <button onclick="showNotif('Données exportées (démo)')" style="margin-left:22px;background:var(--brand-secondary);border:none;padding:11px 23px;border-radius:10px;font-weight:800;cursor:pointer;">Exporter mes données</button>
      <button onclick="showNotif('Suppression demandée (démo)')" style="margin-left:22px;background:#f0b6b6;color:#fff;border:none;padding:11px 23px;border-radius:10px;font-weight:800;cursor:pointer;">Demander suppression</button>
    </div>
  `;
}
function calendarMiniTable() {
  return `
    <table class="calendar-table">
      <thead><tr><th>L</th><th>M</th><th>M</th><th>J</th><th>V</th><th>S</th><th>D</th></tr></thead>
      <tbody>
        <tr>
          <td>9</td><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td>
        </tr>
      </tbody>
    </table>
  `;
}
function calendarEventLine(evt) {
  return `<div class="calendar-evt" style="background:${evt.color}22;">
    <svg class="evt-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="4" fill="${evt.color||'#1c9dea'}"/></svg>
    <span class="evt-time">${evt.time}</span>
    <span class="evt-title">${evt.title}</span>
    <span class="evt-note">${evt.note||""}</span>
  </div>`;
}
function userName(id) {
  const m = state.family.members.find(m=>m.id===id); return m?m.name:"";
}
function statusClass(st) {
  if(st==="En cours") return "status-pending";
  if(st==="À faire") return "status-todo";
  if(st==="Fait") return "status-done";
  return "";
}
/* --- INTERACTIONS --- */
function afterRenderPage() {
  // Chat
  if(["dashboard","chat"].includes(state.page)) renderChat();
  // Chat submit
  const chatForm = document.getElementById('chat-form');
  if(chatForm) {
    chatForm.onsubmit = e => {
      e.preventDefault();
      const inp = document.getElementById('chat-input');
      const txt = inp.value.trim();
      if(txt){
        state.chat.push({from:state.user.id, text:txt});
        renderChat();
        inp.value = "";
      }
    }
    document.getElementById('rephrase-btn').onclick = function(){
      const inp = document.getElementById('chat-input');
      if(inp.value.trim()){
        let txt = inp.value.replace(/(pas|non|nul|bête|fâché|problème|difficile|jamais|impossible|trop)/gi, "un peu compliqué");
        if(!txt.match(/(merci|bravo|chouette|génial|super|content|heureux)/i)){
          txt = "Merci pour ta participation ! " + txt;
        }
        inp.value = txt;
      }
    };
  }
}
function renderChat() {
  const chatList = document.getElementById('chat-list');
  if(!chatList) return;
  chatList.innerHTML = "";
  state.chat.forEach(msg => {
    const row = document.createElement("div");
    row.className = "chat-row " + (msg.from === "bot" ? "bot" : "");
    const bubble = document.createElement("div");
    bubble.className = "chat-msg " + (msg.from === "bot" ? "chat-bot" : "chat-me");
    if(msg.from === "bot"){
      bubble.innerHTML = '<svg style="width:18px;height:18px;vertical-align:middle;margin-right:7px;" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#ffe066"/><ellipse cx="16" cy="13" rx="7" ry="5" fill="#FFF"/><ellipse cx="16" cy="22" rx="9" ry="6" fill="#FFFDE7"/><circle cx="14" cy="13" r="1" fill="#222B45"/><circle cx="18" cy="13" r="1" fill="#222B45"/><rect x="13" y="18" width="6" height="2" rx="1" fill="#FFD600"/></svg>' + msg.text;
    }else{
      bubble.textContent = msg.text;
    }
    row.appendChild(bubble);
    chatList.appendChild(row);
  });
  chatList.scrollTop = chatList.scrollHeight;
}
/* --- TÂCHES --- */
function toggleTaskStatus(id) {
  const t = state.tasks.find(t=>t.id===id);
  if(t) t.status = t.status==="Fait"?"À faire":"Fait";
  renderPageContent();
}
function deleteTask(id) {
  state.tasks = state.tasks.filter(t=>t.id!==id);
  renderPageContent();
}
function addTask() {
  const inp = document.getElementById('task-add-inp');
  const uid = +document.getElementById('task-add-user').value;
  if(inp.value.trim()) {
    state.tasks.push({id:Date.now(), title:inp.value, status:"À faire", assignee:uid});
    inp.value = "";
    renderPageContent();
  }
}
/* --- OVERLAY & MODALS --- */
function showOverlay(type) {
  state.overlay = {type};
  renderOverlay();
}
function closeOverlay() {
  state.overlay = null;
  document.getElementById("overlay-root")?.remove();
}
function renderOverlay() {
  const existing = document.getElementById("overlay-root");
  if(existing) existing.remove();
  const div = document.createElement("div");
  div.id = "overlay-root";
  div.className = "overlay-bg";
  let html = "";
  if(state.overlay.type==="charte") {
    html = `<div class="overlay-content">
      <button class="overlay-close" onclick="closeOverlay()">&times;</button>
      <h2>Charte d’inclusion</h2>
      <ul style="font-size:1.13em;">
        <li><b>Respect</b> des différences et des besoins de chacun</li>
        <li><b>Équité</b> dans les échanges et la répartition des tâches</li>
        <li><b>Accessibilité</b> pour tous : design et contenus adaptés</li>
        <li><b>Bienveillance</b> dans la communication (IA de reformulation, modération)</li>
        <li>Signalement simple, comité de revue transparent</li>
      </ul>
      <div style="font-size:1.02em;color:var(--brand-muted);margin-top:15px;">En utilisant Nesti, vous acceptez ces valeurs.</div>
    </div>`;
  }
  if(state.overlay.type==="privacy") {
    html = `<div class="overlay-content">
      <button class="overlay-close" onclick="closeOverlay()">&times;</button>
      <h2>Politique de confidentialité</h2>
      <ul style="font-size:1.13em;">
        <li>Données limitées au strict nécessaire (RGPD ready)</li>
        <li>Chiffrement en transit et au repos</li>
        <li>Droit d'accès, de portabilité, de suppression à tout moment</li>
        <li>Consentement explicite pour localisation, santé, photos</li>
        <li>Prompts IA anonymisés, pas de profilage</li>
      </ul>
      <div style="font-size:1.02em;color:var(--brand-muted);margin-top:15px;">Contact DPO: privacy@nesti-app.fr</div>
    </div>`;
  }
  if(state.overlay.type==="event") {
    html = `<div class="calendar-modal">
      <h3>Nouvel événement</h3>
      <form id="event-form">
        <label>Titre</label>
        <input id="event-title" required />
        <label>Heure</label>
        <input id="event-time" type="time" required />
        <label>Jour (septembre)</label>
        <input id="event-day" type="number" min="1" max="30" required />
        <label>Note (optionnelle)</label>
        <input id="event-note" />
        <div class="calendar-modal-actions">
          <button class="cancel" type="button" onclick="closeOverlay()">Annuler</button>
          <button class="save" type="submit">Ajouter</button>
        </div>
      </form>
    </div>`;
  }
  div.innerHTML = html;
  document.body.appendChild(div);
  if(state.overlay.type==="event") {
    document.getElementById("event-form").onsubmit = function(e){
      e.preventDefault();
      const title = document.getElementById("event-title").value.trim();
      const time = document.getElementById("event-time").value;
      const day = +document.getElementById("event-day").value;
      const note = document.getElementById("event-note").value.trim();
      if(title && time && day) {
        state.events.push({id:Date.now(), title, time, day, note, creator:state.user.id, color:"#1c9dea"});
        closeOverlay();
        renderPageContent();
        showNotif("Événement ajouté !");
      }
    }
  }
}
function showNotif(msg) {
  const banner = document.getElementById("notif-banner");
  if(!banner) return;
  banner.textContent = msg;
  banner.style.display = "block";
  setTimeout(()=>{banner.style.display="none";},2300);
}
function toggleEasyRead() {
  state.easyread = !state.easyread;
  renderRoot();
}
/* --- INIT --- */
renderRoot();
</script>
</body>
</html>
