<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nesti ‚Äî Plateforme Familiale Inclusive (Pro One-File)</title>
  <meta name="description" content="Prototype professionnel tout-en-un : dashboard familial, calendrier, t√¢ches, chat IA, inclusion, RGPD ‚Äî sans d√©pendances externes."/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Manrope:wght@600;800&display=swap" rel="stylesheet">
  <style>
    /* ==========================
       THEME & VARIABLES (Design pro)
       ========================== */
    :root{
      --bg: #f4fbff;
      --card: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --glass: rgba(255,255,255,0.7);
      --primary: #136bb1;
      --primary-2: #1c9dea;
      --accent: #ffd166;
      --success: #29c48a;
      --danger: #ff6b6b;
      --radius-xl: 18px;
      --radius-lg: 12px;
      --shadow-soft: 0 6px 28px rgba(17, 102, 204, 0.08);
      --shadow-strong: 0 12px 48px rgba(17, 102, 204, 0.12);
      --mono: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --transition: 220ms cubic-bezier(.2,.9,.27,1);
      --max-width: 1180px;
    }
    /* Dark mode support toggle via [data-theme="dark"] on body */
    body { margin:0; font-family:var(--mono); background:linear-gradient(180deg,#f8fdff 0%,var(--bg) 100%); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    [data-theme="dark"]{ --bg:#071320; --card:#0b1622; --muted:#93a6bd; --text:#f4f8fb; --glass: rgba(10,18,28,0.55); --shadow-soft: 0 10px 30px rgba(0,0,0,0.6); --shadow-strong: 0 18px 50px rgba(0,0,0,0.7); }
    .app { display:flex; min-height:100vh; align-items:stretch; justify-content:flex-start; }
    /* ==========================
       SIDEBAR
       ========================== */
    .sidebar { width:300px; padding:32px 22px; background:linear-gradient(180deg, var(--glass), rgba(255,255,255,0.45)); border-top-right-radius:var(--radius-xl); border-bottom-right-radius:var(--radius-xl); box-shadow:var(--shadow-soft); display:flex; flex-direction:column; gap:22px; }
    [data-theme="dark"] .sidebar{ background:linear-gradient(180deg,var(--glass), rgba(255,255,255,0.02)); }
    .logo { display:flex; align-items:center; gap:12px; }
    .logo svg { width:46px; height:46px; border-radius:9px; }
    .brand { font-weight:800; font-size:1.6rem; color:var(--primary-2); }
    .nav { display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .nav button { background:none; border:none; text-align:left; padding:12px 14px; border-radius:10px; display:flex; gap:12px; align-items:center; cursor:pointer; font-weight:600; color:var(--muted); transition:all var(--transition); }
    .nav button:hover, .nav button:focus { transform:translateX(4px); color:var(--primary-2); box-shadow:var(--shadow-soft); }
    .nav button.active { background:linear-gradient(90deg, rgba(28,157,234,0.12), rgba(255,209,102,0.06)); color:var(--primary-2); }
    .spacer { flex:1; }
    .profile { display:flex; gap:12px; align-items:center; padding-top:12px; border-top:1px solid rgba(0,0,0,0.04); }
    .avatar { width:48px; height:48px; border-radius:10px; background:linear-gradient(180deg,#fff,#f0f8ff); border:1px solid rgba(0,0,0,0.04); }
    .profile .meta { display:flex; flex-direction:column; }
    .role { font-size:0.9rem; color:var(--muted); }
    .logout { margin-left:auto; background:none; border:none; color:var(--primary); cursor:pointer; font-weight:700; }
    /* ==========================
       MAIN LAYOUT
       ========================== */
    .main { flex:1; padding:42px; display:flex; justify-content:center; }
    .container { width:100%; max-width:var(--max-width); display:grid; grid-template-columns: 1.1fr 2fr 1fr; gap:28px; align-items:start; }
    .header { grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; gap:18px; margin-bottom:6px; }
    .header-left { display:flex; flex-direction:column; gap:6px; }
    .title { font-size:2.2rem; font-weight:800; }
    .subtitle { color:var(--muted); font-weight:600; }
    .header-right { display:flex; gap:12px; align-items:center; }
    .search { border-radius:12px; padding:10px 12px; border:1px solid var(--shadow-soft); background:var(--card); min-width:260px; display:flex; align-items:center; gap:10px; }
    .search input { border:none; outline:none; background:transparent; font-weight:600; width:100%; }
    .cta { background:var(--accent); padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; border:none; box-shadow:var(--shadow-soft); }
    /* ==========================
       CARDS / PANELS
       ========================== */
    .card { background:var(--card); border-radius:var(--radius-lg); padding:20px; box-shadow:var(--shadow-soft); }
    .card h3 { margin:0 0 12px 0; font-size:1.05rem; font-weight:800; }
    .calendar { display:flex; flex-direction:column; gap:10px; }
    .mini-cal { border-radius:10px; padding:12px; background:linear-gradient(180deg, rgba(20,130,200,0.02), rgba(255,255,255,0.02)); }
    .events { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .event-item { display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.4), rgba(255,255,255,0.2)); border-left:6px solid var(--primary); }
    .event-meta { display:flex; flex-direction:column; }
    .event-time { font-weight:800; color:var(--muted); font-size:0.95rem; }
    .event-title { font-weight:800; }
    .event-note { color:var(--muted); font-size:0.9rem; }
    /* TASKS */
    .tasks-list { display:flex; flex-direction:column; gap:10px; }
    .task-row { display:flex; align-items:center; gap:12px; padding:9px; border-radius:10px; border:1px solid rgba(0,0,0,0.03); }
    .task-title { flex:1; font-weight:700; }
    .task-meta { color:var(--muted); font-size:0.9rem; }
    .chip { padding:6px 10px; border-radius:999px; background:linear-gradient(90deg,#fff, rgba(0,0,0,0.02)); font-weight:700; }
    /* CHAT */
    .chat { display:flex; flex-direction:column; gap:12px; height:100%; }
    .chat-list { display:flex; flex-direction:column; gap:10px; max-height:360px; overflow:auto; padding-right:8px; }
    .bubble { display:inline-block; padding:10px 14px; border-radius:14px; max-width:78%; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.04); }
    .bubble.me { background:linear-gradient(90deg,#e7f6ff,#e9f6ff); margin-left:auto; }
    .bubble.bot { background:linear-gradient(90deg,#fff7e6,#fff8e9); margin-right:auto; }
    .chat-input { display:flex; gap:10px; align-items:center; }
    .chat-input input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.05); background:var(--card); font-weight:700; }
    .chat-actions button { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
    .rephrase { background:var(--primary-2); color:#fff; }
    /* ACCESSIBILITY / SETTINGS */
    .controls { display:flex; gap:10px; align-items:center; }
    .toggle { display:inline-flex; align-items:center; gap:8px; cursor:pointer; }
    .switch { width:42px; height:24px; border-radius:999px; background:#e6eefb; position:relative; padding:3px; transition:background var(--transition); }
    .switch .dot { width:18px; height:18px; border-radius:50%; background:#fff; position:absolute; left:3px; top:3px; transition:left var(--transition); box-shadow:var(--shadow-soft); }
    .switch.on { background:linear-gradient(90deg,var(--primary-2),var(--accent)); }
    .switch.on .dot { left:21px; }
    /* OVERLAYS / MODALS */
    .overlay { position:fixed; inset:0; background:rgba(2,6,23,0.55); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:var(--card); border-radius:14px; padding:22px; width:min(880px,92vw); box-shadow:var(--shadow-strong); }
    .modal h2 { margin:0 0 12px 0; font-size:1.3rem; }
    .modal .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .modal .actions { display:flex; gap:12px; margin-top:12px; }
    /* FOOTER SMALL PRINT */
    .foot { text-align:center; color:var(--muted); margin-top:26px; font-size:0.9rem; }
    /* RESPONSIVE */
    @media (max-width:1100px){
      .container { grid-template-columns:1fr; }
      .sidebar { display:none; }
      .main { padding:20px; }
    }
    /* UTILITY */
    .hidden { display:none !important; }
    .muted { color:var(--muted); }
    .mt { margin-top:14px; }
    .mb { margin-bottom:14px; }
    .frow { display:flex; gap:12px; align-items:center; }
    .pill { padding:6px 10px; border-radius:999px; background:rgba(0,0,0,0.03); font-weight:700; }
    /* simple accessible focus */
    button:focus, input:focus, select:focus { outline:3px solid rgba(28,157,234,0.18); outline-offset:2px; }
  </style>
</head>
<body>
  <div id="root" class="app" role="application" aria-label="Nesti Platform"></div>

  <template id="app-template">
    <aside class="sidebar" role="navigation" aria-label="Menu principal">
      <div class="logo" id="sidebar-logo">
        <!-- logo svg inline -->
        <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
          <defs>
            <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0" stop-color="#1c9dea"/>
              <stop offset="1" stop-color="#ffd166"/>
            </linearGradient>
          </defs>
          <rect width="64" height="64" rx="12" fill="url(#g1)"></rect>
          <g transform="translate(8,12)">
            <circle cx="16" cy="14" r="14" fill="#fff"/>
            <ellipse cx="17" cy="19" rx="9" ry="6" fill="#ffd166"/>
            <circle cx="24" cy="14" r="1.8" fill="#222b45"/>
          </g>
        </svg>
        <div class="brand">Nesti</div>
      </div>

      <nav class="nav" id="nav">
        <!-- nav buttons will be injected -->
      </nav>

      <div class="spacer"></div>

      <div class="profile" id="profile">
        <div class="avatar" id="profile-avatar" role="img" aria-label="Photo du profil"></div>
        <div class="meta">
          <div id="profile-name" style="font-weight:800;">Nom</div>
          <div class="role" id="profile-role">Role</div>
        </div>
        <button class="logout" id="logout" title="Se d√©connecter" aria-label="Se d√©connecter">‚Üí</button>
      </div>
    </aside>

    <main class="main" id="main">
      <div class="container" id="container">
        <header class="header" role="banner">
          <div class="header-left">
            <div class="title" id="title">Bonjour, utilisateur</div>
            <div class="subtitle">Organisation et bien-√™tre pour toute la famille</div>
          </div>
          <div class="header-right">
            <div class="search" role="search" aria-label="Recherche">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#1c9dea" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="11.5" cy="11.5" r="5.5" stroke="#1c9dea" stroke-width="1.6"></circle></svg>
              <input id="search-input" placeholder="Rechercher √©v√©nement, t√¢che, message..." aria-label="Rechercher">
            </div>
            <div class="controls">
              <div class="toggle" title="Mode sombre">
                <div id="dark-switch" class="switch" role="button" tabindex="0" aria-pressed="false" aria-label="Basculer mode sombre">
                  <div class="dot"></div>
                </div>
              </div>
              <button class="cta" id="new-event-cta">+ Nouveau</button>
            </div>
          </div>
        </header>

        <!-- Left column: calendar + tasks compact -->
        <section class="card" id="left-col" aria-labelledby="left-heading">
          <h3 id="left-heading">Emploi du temps</h3>
          <div class="calendar">
            <div class="mini-cal" id="mini-cal" aria-hidden="false">
              <!-- small calendar will be rendered here -->
            </div>
            <div class="events" id="today-events" aria-live="polite">
              <!-- event items -->
            </div>
          </div>

          <div class="mt">
            <h3>Liste de t√¢ches</h3>
            <div class="tasks-list" id="task-list">
              <!-- tasks -->
            </div>
            <div class="mt frow">
              <input id="new-task-input" placeholder="Nouvelle t√¢che..." aria-label="Nouvelle t√¢che" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);">
              <button id="add-task-btn" class="pill">Ajouter</button>
            </div>
          </div>
        </section>

        <!-- Middle column: chat, kanban, insights -->
        <section class="card" id="center-col">
          <h3>Chat familial <span class="chip" id="chat-status">IA active</span></h3>
          <div class="chat" id="chat">
            <div class="chat-list" id="chat-list" role="log" aria-live="polite">
              <!-- messages -->
            </div>
            <div class="chat-input">
              <input id="chat-input" placeholder="√âcrire un message..." aria-label="√âcrire un message">
              <div class="chat-actions">
                <button id="send-btn" class="pill">Envoyer</button>
                <button id="rephrase-btn" class="rephrase">Reformuler</button>
              </div>
            </div>
          </div>

          <div class="mt">
            <h3>R√©sum√© & Suggestions IA</h3>
            <div id="ai-suggestions" class="muted">L'assistant peut reformuler, proposer activit√©s inclusives et r√©sumer les conversations.</div>
          </div>
        </section>

        <!-- Right column: activities, well-being -->
        <aside class="card" id="right-col" aria-labelledby="right-heading">
          <h3 id="right-heading">Activit√©s inclusives</h3>
          <div id="activities" class="mt">
            <!-- activities list -->
          </div>

          <div class="mt">
            <h3>Votre bien-√™tre</h3>
            <div class="muted">Courtes activit√©s, guides et rappels pour la famille</div>
            <div class="mt">
              <button id="start-meditation" class="pill">D√©marrer m√©ditation</button>
            </div>
          </div>

          <div class="mt">
            <h3>Param√®tres rapides</h3>
            <div class="frow mt">
              <label for="easy-read" class="muted">Lecture facile</label>
              <div style="margin-left:auto;" class="toggle"><div id="easy-switch" class="switch" role="button" tabindex="0" aria-pressed="false"><div class="dot"></div></div></div>
            </div>
            <div class="frow mt">
              <label class="muted">Confidentialit√©</label>
              <button id="privacy-btn" class="pill" style="margin-left:auto;">Voir</button>
            </div>
          </div>
        </aside>

        <!-- Footer / legal -->
        <div class="card" style="grid-column:1/-1;margin-top:18px;">
          <div class="frow" style="justify-content:space-between; align-items:center;">
            <div class="muted">¬© Nesti ‚Äî Prototype. Donn√©es techniques et d‚Äôint√©gration disponibles pour threading backend.</div>
            <div class="frow">
              <button id="export-data" class="pill">Exporter donn√©es</button>
              <button id="delete-account" class="pill" style="background:var(--danger); color:#fff;">Demander suppression</button>
            </div>
          </div>
        </div>

      </div>
    </main>
  </template>

  <!-- MODAL ROOT -->
  <div id="modal-root" aria-live="assertive"></div>

  <script>
  /* ==========================
     PROFESSIONAL SINGLE-FILE APP
     - modular, commented, extensible
     - no external deps
     - persistent localStorage
     - "IA" local heuristics and placeholders for external APIs
     ========================== */

  /* --------------------------
     Utilities
     -------------------------- */
  const $ = selector => document.querySelector(selector);
  const $all = selector => Array.from(document.querySelectorAll(selector));
  const nowStr = () => new Date().toISOString();
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const uid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;

  /* --------------------------
     Persistent Store (localStorage)
     - Simple wrapper to persist app state and allow export/import
     -------------------------- */
  const Store = {
    key: 'nesti_pro_data_v1',
    read(){
      try {
        const raw = localStorage.getItem(this.key);
        if(!raw) return null;
        return JSON.parse(raw);
      } catch(e) { console.warn('Store read error', e); return null; }
    },
    write(data){
      try {
        localStorage.setItem(this.key, JSON.stringify(data));
      } catch(e) { console.warn('Store write error', e); }
    },
    export(){
      const blob = new Blob([JSON.stringify(this.read()||{}, null, 2)], {type:'application/json'});
      const u = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = u; a.download = 'nesti-export-'+(new Date()).toISOString().slice(0,10)+'.json';
      a.click(); URL.revokeObjectURL(u);
    },
    clear(){ localStorage.removeItem(this.key); }
  };

  /* --------------------------
     Seed / Initial Data
     -------------------------- */
  const SEED = {
    families: [{
      id: 'fam_1',
      name: 'Famille Demo',
      members: [
        {id:'u_1', name:'Emma', role:'parent1', email:'emma@mail.com', avatar:''},
        {id:'u_2', name:'Louis', role:'parent2', email:'louis@mail.com', avatar:''},
        {id:'u_3', name:'Alice', role:'enfant', email:'alice@mail.com', avatar:''},
        {id:'u_4', name:'Mamie', role:'invite', email:'mamie@mail.com', avatar:''}
      ]
    }],
    events: [
      { id: 'ev_1', title:'Heure du go√ªter', time:'15:00', day:10, note:'G√¢teau au chocolat', creator:'u_1', created_at:nowStr(), color:'#ffd166' },
      { id: 'ev_2', title:'Cours de piano', time:'17:00', day:10, note:'Salle 2', creator:'u_2', created_at:nowStr(), color:'#1c9dea' },
      { id: 'ev_3', title:'Jeux de famille', time:'20:00', day:10, note:'Choisir le jeu', creator:'u_3', created_at:nowStr(), color:'#29c48a' }
    ],
    tasks: [
      { id:'t_1', title:'Acheter du pain', status:'√Ä faire', assignee:'u_1', created_at:nowStr() },
      { id:'t_2', title:'Pr√©parer le go√ªter', status:'En cours', assignee:'u_2', created_at:nowStr() },
      { id:'t_3', title:'Ranger la chambre', status:'Fait', assignee:'u_3', created_at:nowStr() }
    ],
    chat:[
      {id:'m_1', from:'u_1', text:'Salut √† tous! Quelle activit√© ce soir ?', created_at:nowStr()},
      {id:'m_2', from:'bot', text:"Bonjour! Je peux vous sugg√©rer la derni√®re expo sur l'art-th√©rapie √† 18h.", created_at:nowStr()}
    ],
    activities: [
      {id:'a_1', title:'Expo sur l‚Äôart-th√©rapie', place:'Mus√©e de l‚Äôart moderne', tags:['inclusion','culture'], color:'#ffd166'},
      {id:'a_2', title:'Atelier peinture', place:'Centre culturel', tags:['cr√©atif'], color:'#1c9dea'}
    ],
    settings: {
      easyRead:false,
      dark:false,
      consent:{ location:false, analytics:false }
    },
    meta:{ created_at: nowStr() }
  };

  /* --------------------------
     App State
     -------------------------- */
  const App = {
    state: {
      user: null, // {id,name,role,email}
      family: null,
      page: 'dashboard',
      ...SEED
    },
    init(){
      // Hydrate from store, fallback to SEED
      const data = Store.read();
      if(data){
        this.state = {...this.state, ...data};
      } else {
        this.state = {...this.state}; // uses seed included
        Store.write(this.state);
      }
      // mount template
      this.mount();
    },
    persist(){ Store.write(this.state); },
    mount(){
      const root = document.getElementById('root');
      root.innerHTML = document.getElementById('app-template').innerHTML;
      // initial ui & bindings
      this.bindNav();
      this.bindProfile();
      this.bindGlobal();
      this.renderAll();
    },
    bindNav(){
      const nav = $('#nav');
      const items = [
        {id:'dashboard', label:'Dashboard'},
        {id:'calendar', label:'Calendrier'},
        {id:'tasks', label:'T√¢ches'},
        {id:'chat', label:'Chat'},
        {id:'activities', label:'Activit√©s'},
        {id:'settings', label:'Param√®tres'}
      ];
      nav.innerHTML = '';
      items.forEach(it => {
        const btn = document.createElement('button');
        btn.className = 'nav-item' + (this.state.page === it.id ? ' active' : '');
        btn.dataset.page = it.id;
        btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 7h18" stroke="#1c9dea" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg><span>${it.label}</span>`;
        btn.onclick = () => { this.navigate(it.id); };
        nav.appendChild(btn);
      });
    },
    bindProfile(){
      const family = this.state.families[0];
      this.state.family = family;
      const user = family.members[0]; // default user for initial demo
      this.state.user = user;
      // profile UI
      $('#profile-name').textContent = user.name;
      $('#profile-role').textContent = (user.role || 'Membre');
      $('#profile-avatar').textContent = ''; $('#profile-avatar').style.backgroundImage = `url('https://www.gravatar.com/avatar/${btoa(user.email||user.name)}?d=identicon')`;
      $('#logout').onclick = () => { this.logout(); };
      $('#title').textContent = `Bonjour, ${user.name}`;
    },
    bindGlobal(){
      // dark switch
      const darkSwitch = $('#dark-switch');
      const easySwitch = $('#easy-switch');
      darkSwitch.onclick = () => { this.toggleDark(); };
      darkSwitch.onkeydown = e => { if(e.key === 'Enter' || e.key === ' ') this.toggleDark(); };
      easySwitch.onclick = () => { this.toggleEasy(); };
      $('#new-event-cta').onclick = () => { this.openEventModal(); };
      $('#add-task-btn').onclick = () => { this.addTaskFromInput(); };
      $('#export-data').onclick = () => { Store.export(); showToast('Export d√©marr√©'); };
      $('#delete-account').onclick = () => { this.requestAccountDeletion(); };
      $('#privacy-btn').onclick = () => { this.openPrivacy(); };
      $('#start-meditation').onclick = () => { this.startMeditation(); };
      $('#search-input').addEventListener('input', (e)=> this.search(e.target.value));
      // chat
      $('#send-btn').onclick = ()=> this.sendChat();
      $('#rephrase-btn').onclick = ()=> this.rephraseInput();
      $('#rephrase-btn').onkeydown = e => { if(e.key==='Enter') this.rephraseInput(); };
      $('#chat-input').onkeydown = e => { if(e.key === 'Enter') this.sendChat(); };
    },
    renderAll(){
      // render left, center, right
      this.renderMiniCalendar();
      this.renderEvents();
      this.renderTasks();
      this.renderChat();
      this.renderActivities();
      this.highlightNav();
      this.applyTheme();
    },
    highlightNav(){
      $all('.nav .nav-item').forEach(b => b.classList.toggle('active', b.dataset.page === this.state.page));
    },
    navigate(page){
      this.state.page = page;
      this.renderAll();
      this.highlightNav();
    },

    /* --------------------------
       THEME & ACCESSIBILITY
       -------------------------- */
    toggleDark(){
      this.state.settings.dark = !this.state.settings.dark;
      document.body.setAttribute('data-theme', this.state.settings.dark ? 'dark' : 'light');
      $('#dark-switch').classList.toggle('on', this.state.settings.dark);
      $('#dark-switch').setAttribute('aria-pressed', String(this.state.settings.dark));
      this.persist();
    },
    toggleEasy(){
      this.state.settings.easyRead = !this.state.settings.easyRead;
      document.body.classList.toggle('easyread', !!this.state.settings.easyRead);
      $('#easy-switch').classList.toggle('on', !!this.state.settings.easyRead);
      this.persist();
    },

    /* --------------------------
       CALENDAR & EVENTS
       -------------------------- */
    renderMiniCalendar(){
      const el = $('#mini-cal');
      // render a simple week with current dates (demo)
      const today = new Date();
      const days = Array.from({length:7}, (_,i)=> {
        const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() + (i-3));
        return {day:d.getDate(), mon:d.toLocaleString('fr-FR',{month:'short'}), isToday: d.toDateString() === today.toDateString()};
      });
      el.innerHTML = `<div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">
        ${days.map(d=>`<div style="text-align:center;padding:8px;border-radius:8px;${d.isToday?'background:linear-gradient(90deg,#e9f6ff,#f6fff1);':''}"><div style="font-weight:800;">${d.day}</div><div style="font-size:0.85rem;color:${d.isToday?'var(--primary-2)':'var(--muted)'}">${d.mon}</div></div>`).join('')}
      </div>`;
    },
    renderEvents(){
      const container = $('#today-events');
      const todayDay = 10; // static demo day
      const evts = this.state.events.filter(e => e.day === todayDay).sort((a,b)=> a.time.localeCompare(b.time));
      container.innerHTML = evts.map(e => `
        <div class="event-item" role="article" aria-label="${e.title}">
          <div style="width:8px;height:40px;border-radius:6px;background:${e.color || '#1c9dea'}"></div>
          <div class="event-meta">
            <div class="event-time">${e.time}</div>
            <div class="event-title">${e.title}</div>
            <div class="event-note">${e.note || ''}</div>
          </div>
        </div>
      `).join('') || `<div class="muted">Aucun √©v√©nement aujourd'hui</div>`;
    },
    openEventModal(){
      const root = $('#modal-root'); root.innerHTML = '';
      const overlay = document.createElement('div'); overlay.className = 'overlay'; overlay role='dialog';
      const modal = document.createElement('div'); modal.className = 'modal';
      modal.innerHTML = `
        <h2>Cr√©er un √©v√©nement</h2>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <label>Titre<input id="modal-ev-title" placeholder="Nom de l'√©v√©nement" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"></label>
          <label>Jour (ex: 10)<input id="modal-ev-day" type="number" min="1" max="31" value="10" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"></label>
          <label>Heure<input id="modal-ev-time" type="time" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"></label>
          <label>Note<textarea id="modal-ev-note" rows="3" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"></textarea></label>
          <div class="actions"><button id="modal-ev-cancel" class="pill">Annuler</button><button id="modal-ev-save" class="pill" style="background:var(--primary-2);color:#fff;">Ajouter</button></div>
        </div>
      `;
      overlay.appendChild(modal); root.appendChild(overlay);
      $('#modal-ev-cancel').onclick = () => { root.innerHTML = ''; };
      $('#modal-ev-save').onclick = () => {
        const title = $('#modal-ev-title').value.trim();
        const day = Number($('#modal-ev-day').value);
        const time = $('#modal-ev-time').value;
        const note = $('#modal-ev-note').value.trim();
        if(!title || !time || !day) { showToast('Veuillez remplir titre, jour et heure'); return; }
        this.state.events.push({ id: uid('ev'), title, day, time, note, creator:this.state.user.id, created_at:nowStr(), color:'#1c9dea' });
        root.innerHTML = ''; this.persist(); this.renderEvents(); showToast('√âv√©nement ajout√©');
      };
    },

    /* --------------------------
       TASKS
       -------------------------- */
    renderTasks(){
      const list = $('#task-list');
      list.innerHTML = this.state.tasks.map(t => `
        <div class="task-row" data-id="${t.id}">
          <input type="checkbox" ${t.status==='Fait' ? 'checked' : ''} onchange="App.toggleTask('${t.id}', event)" aria-label="Marquer t√¢che">
          <div class="task-title">${t.title}</div>
          <div class="task-meta">${this.nameFor(t.assignee)}</div>
          <div><button onclick="App.removeTask('${t.id}')" style="background:none;border:none;color:var(--danger);font-weight:800;cursor:pointer;">√ó</button></div>
        </div>
      `).join('') || `<div class="muted">Aucune t√¢che</div>`;
    },
    addTaskFromInput(){
      const val = $('#new-task-input').value.trim(); if(!val) { showToast('Entrez une t√¢che'); return; }
      this.state.tasks.push({ id: uid('t'), title: val, status:'√Ä faire', assignee:this.state.user.id, created_at:nowStr() });
      $('#new-task-input').value=''; this.persist(); this.renderTasks(); showToast('T√¢che ajout√©e');
    },
    toggleTask(id, e){
      const t = this.state.tasks.find(x => x.id === id); if(!t) return;
      t.status = e.target.checked ? 'Fait' : '√Ä faire'; this.persist(); this.renderTasks();
    },
    removeTask(id){
      this.state.tasks = this.state.tasks.filter(t => t.id !== id); this.persist(); this.renderTasks(); showToast('T√¢che supprim√©e');
    },

    /* --------------------------
       CHAT & IA (local heuristics)
       -------------------------- */
    renderChat(){
      const el = $('#chat-list'); el.innerHTML = '';
      this.state.chat.forEach(m => {
        const div = document.createElement('div');
        const isBot = (m.from === 'bot');
        div.className = 'bubble ' + (isBot ? 'bot' : 'me');
        div.setAttribute('role','article');
        div.innerHTML = `${escapeHtml(m.text)}<div style="font-size:0.78rem;color:var(--muted);margin-top:6px;font-weight:600;">${isBot ? 'Assistant' : this.nameFor(m.from)} ‚Ä¢ ${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
        el.appendChild(div);
      });
      el.scrollTop = el.scrollHeight;
    },
    sendChat(){
      const input = $('#chat-input'); const txt = input.value.trim(); if(!txt) return;
      const msg = { id: uid('m'), from: this.state.user.id, text: txt, created_at: nowStr() };
      this.state.chat.push(msg); input.value=''; this.persist(); this.renderChat();
      // trigger assistant: light moderation -> reformulation suggestions -> content-based suggestion
      setTimeout(()=> this.aiRespond(msg), 700);
    },
    rephraseInput(){
      const input = $('#chat-input'); const txt = input.value.trim(); if(!txt) { showToast('Tapez un message pour reformuler'); return; }
      const reform = this.ai.rephrase(txt);
      input.value = reform;
      showToast('Reformulation propos√©e');
    },
    aiRespond(userMessage){
      // naive pipeline:
      const text = userMessage.text;
      // detect offensive -> propose reformulation rather than posting as assistant message
      const offensive = this.ai.detectOffensive(text);
      if(offensive) {
        const reform = this.ai.rephrase(text, 'bienveillant');
        this.state.chat.push({ id: uid('m'), from:'bot', text: `Le message semble potentiellement blessant. Proposition: "${reform}"`, created_at: nowStr() });
        this.persist(); this.renderChat(); return;
      }
      // else propose activity suggestions if match keywords
      const lower = text.toLowerCase();
      if(/expo|activit√©|jeu|sortie|parc|cin√©ma|th√©√¢tre/.test(lower)){
        const reco = this.ai.suggestActivities(lower, this.state.activities);
        this.state.chat.push({ id: uid('m'), from:'bot', text: `Suggestions: ${reco.map(r=>r.title+' ('+r.place+')').join(' ‚Äî ')}`, created_at: nowStr() });
        this.persist(); this.renderChat();
        return;
      }
      // else bot acknowledges and optionally summarizes last 5 messages
      this.state.chat.push({ id: uid('m'), from:'bot', text: this.ai.smallTalk(text), created_at: nowStr() });
      this.persist(); this.renderChat();
    },

    /* --------------------------
       ACTIVITIES & INCLUSION
       -------------------------- */
    renderActivities(){
      const el = $('#activities');
      el.innerHTML = this.state.activities.map(a => `
        <div style="border-left:6px solid ${a.color}; padding:10px 12px; border-radius:8px; margin-bottom:10px;">
          <div style="font-weight:800;">${a.title}</div>
          <div style="font-size:0.95rem;color:var(--muted)">${a.place}</div>
          <div style="margin-top:8px;color:var(--muted);font-size:0.9rem">Tags: ${a.tags.join(', ')}</div>
          <div style="margin-top:8px;"><button class="pill" onclick="App.addActivityToCalendar('${a.id}')">Ajouter au calendrier</button></div>
        </div>
      `).join('');
    },
    addActivityToCalendar(aid){
      const a = this.state.activities.find(x => x.id===aid);
      if(!a) return showToast('Activit√© non trouv√©e');
      // create event tomorrow 18:00 as demo
      const d = new Date(); d.setDate(d.getDate()+1);
      this.state.events.push({ id: uid('ev'), title:a.title, day: d.getDate(), time:'18:00', note: a.place, creator:this.state.user.id, created_at:nowStr(), color:a.color });
      this.persist(); this.renderEvents(); showToast('Activit√© ajout√©e au calendrier');
    },

    /* --------------------------
       MEDITATION / TIMERS
       -------------------------- */
    startMeditation(){
      // simple guided demo: display modal with timer
      const root = $('#modal-root'); root.innerHTML = '';
      const overlay = document.createElement('div'); overlay.className = 'overlay';
      const modal = document.createElement('div'); modal.className = 'modal';
      modal.innerHTML = `<h2>Pause m√©ditation ‚Äî 3 minutes</h2><div id="med-status" style="font-weight:700;margin-top:8px;">Respirez profond√©ment...</div><div class="mt"><button id="med-end" class="pill">Terminer</button></div>`;
      overlay.appendChild(modal); root.appendChild(overlay);
      let remaining = 180;
      const tick = () => {
        const s = Math.max(0, remaining);
        const mm = String(Math.floor(s/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0');
        $('#med-status').textContent = `Temps restant ${mm}:${ss}`;
        remaining--;
        if(remaining < 0){ clearInterval(timer); $('#med-status').textContent = 'Session termin√©e ‚Äî bonne d√©tente !'; showToast('M√©ditation termin√©e'); setTimeout(()=> root.innerHTML='',1200); }
      };
      tick();
      const timer = setInterval(tick,1000);
      $('#med-end').onclick = ()=>{ clearInterval(timer); root.innerHTML=''; showToast('M√©ditation arr√™t√©e'); };
    },

    /* --------------------------
       SETTINGS & PRIVACY
       -------------------------- */
    openPrivacy(){
      const root = $('#modal-root'); root.innerHTML = '';
      const overlay = document.createElement('div'); overlay.className = 'overlay';
      const modal = document.createElement('div'); modal.className = 'modal';
      modal.innerHTML = `<h2>Politique de confidentialit√© (Brouillon)</h2>
        <p style="color:var(--muted);font-size:0.95rem;">Nous collectons le minimum n√©cessaire. Les donn√©es peuvent √™tre export√©es ou supprim√©es. Pour d√©mo, les donn√©es sont stock√©es localement dans votre navigateur.</p>
        <div class="grid mt">
          <div><b>Droits</b><p class="muted">Acc√®s, rectification, suppression, portabilit√©.</p></div>
          <div><b>IA & Prompts</b><p class="muted">Les prompts sont anonymis√©s avant envoi si un back-end est configur√©.</p></div>
        </div>
        <div class="actions"><button id="close-privacy" class="pill">Fermer</button><button id="export-privacy" class="pill" style="background:var(--primary-2);color:#fff">Exporter</button></div>
      `;
      overlay.appendChild(modal); root.appendChild(overlay);
      $('#close-privacy').onclick = ()=> root.innerHTML = '';
      $('#export-privacy').onclick = ()=>{ Store.export(); showToast('Export demand√©'); };
    },

    /* --------------------------
       ACCOUNT DELETION (RGPD demo)
       -------------------------- */
    requestAccountDeletion(){
      const ok = confirm('Voulez-vous demander la suppression de votre compte (d√©monstration locale) ?');
      if(!ok) return;
      // simulate deletion
      Store.clear();
      showToast('Demande re√ßue ‚Äî donn√©es locales supprim√©es');
      // reload demo
      setTimeout(()=> location.reload(), 1400);
    },

    /* --------------------------
       HELPERS
       -------------------------- */
    nameFor(id){
      if(!this.state.family) return '';
      if(id === 'bot') return 'Assistant';
      return this.state.family.members.find(m=>m.id===id)?.name || '';
    },
    logout(){ this.state.user = null; showToast('D√©connect√© ‚Äî rechargement'); setTimeout(()=> location.reload(),600); },

    /* --------------------------
       SEARCH
       -------------------------- */
    search(q){
      q = String(q || '').trim().toLowerCase();
      if(!q) { this.renderAll(); return; }
      // highlight simple matches in tasks/events
      const tasks = this.state.tasks.filter(t => t.title.toLowerCase().includes(q));
      const events = this.state.events.filter(e => (e.title + ' ' + (e.note||'')).toLowerCase().includes(q));
      // render filtered
      $('#task-list').innerHTML = tasks.map(t=>`<div class="task-row"><div class="task-title">${t.title}</div><div class="task-meta">${this.nameFor(t.assignee)}</div></div>`).join('') || '<div class="muted">Aucun r√©sultat</div>';
      $('#today-events').innerHTML = events.map(e=>`<div class="event-item"><div style="width:8px;height:40px;background:${e.color};"></div><div class="event-meta"><div class="event-time">${e.time}</div><div class="event-title">${e.title}</div></div></div>`).join('') || '<div class="muted">Aucun √©v√©nement</div>';
    },

    /* --------------------------
       "IA" utility (local heuristics) - accessible & privacy-first
       - detectOffensive: simple rule-based check
       - rephrase: simple templating plus synonyms
       - suggestActivities: match keywords and scoring
       - smallTalk: friendly canned responses
       -------------------------- */
    ai: {
      offensiveWords: ['idiot','stupide','nul','hate','d√©teste'],
      synonyms: {
        'f√¢ch√©':'un peu contrari√©',
        'nul':'peu adapt√©',
        'idiot':'inappropri√©',
        'impossible':'compliqu√©'
      },
      detectOffensive(text){
        const t = (text||'').toLowerCase();
        return this.offensiveWords.some(w => t.includes(w));
      },
      rephrase(text, tone='bienveillant'){
        // very small local rephraser: polite prefix + replace offensive synonyms
        let result = text;
        for(const [k,v] of Object.entries(this.synonyms)){
          const re = new RegExp('\\b'+escapeRegExp(k)+'\\b','gi');
          result = result.replace(re, v);
        }
        if(tone === 'bienveillant') {
          if(!/merci|merci beaucoup|svp|s\'il vous pla√Æt/i.test(text)) result = 'Merci ‚Äî ' + result;
          // calm voice
          result = result.replace(/!/g, '.');
        }
        // trim & capitalise
        result = result.trim(); result = result.charAt(0).toUpperCase() + result.slice(1);
        return result;
      },
      suggestActivities(msg, activities){
        // simple scoring: if any tag word exists
        const words = msg.split(/\W+/).map(s=>s.toLowerCase());
        const score = activities.map(a=> {
          const match = a.tags.reduce((acc,tag)=> acc + (words.includes(tag) ? 2 : 0), 0) + (words.some(w=> a.title.toLowerCase().includes(w)) ? 3:0);
          return {act:a, score:match};
        }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).map(x=>x.act);
        // fallback: return top 2
        return score.length ? score : activities.slice(0,2);
      },
      smallTalk(userText){
        const t = userText.toLowerCase();
        if(/merci|merci beaucoup/.test(t)) return "Avec plaisir ! üíõ";
        if(/bonjour|salut/.test(t)) return "Bonjour ! Comment puis-je aider la famille aujourd'hui ?";
        if(/qui est|pr√©sente/.test(t)) return "Voici la liste des membres connect√©s : " + App.state.family.members.map(m=>m.name).join(', ');
        return "Merci pour le message ‚Äî je peux proposer des activit√©s, reformuler un texte ou r√©sumer une discussion si vous le souhaitez.";
      }
    }
  };

  /* --------------------------
     Small helpers exposed to template for inline onclick (simpler integration)
     -------------------------- */
  window.App = {
    toggleTask: (id, e) => App.toggleTask(id, e),
    removeTask: id => App.removeTask(id),
    addActivityToCalendar: id => App.addActivityToCalendar(id),
    logout: () => App.logout(),
    toggleDark: () => App.toggleDark(),
    requestAccountDeletion: () => App.requestAccountDeletion(),
    startMeditation: () => App.startMeditation()
  };

  /* --------------------------
     Safety & misc helpers
     -------------------------- */
  function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]); }
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
  function showToast(msg, ms=2200){ const t = $('#notif-banner'); t.textContent = msg; t.style.display='block'; setTimeout(()=> t.style.display='none', ms); }

  /* --------------------------
     Init app
     -------------------------- */
  (function init(){
    // initialize store if empty
    if(!Store.read()) Store.write(SEED);
    App.init();
  })();

  </script>
</body>
</html>
