<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Nesti — Plateforme Familiale Inclusive</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --nesti-bg: #F5FAFC;
      --nesti-card: #FFF;
      --nesti-primary: #53B0E5;
      --nesti-yellow: #FFE066;
      --nesti-sidebar: #EAF6FB;
      --nesti-text: #222B45;
      --nesti-muted: #6B7280;
      --nesti-chat-bg: #EAF6FB;
      --nesti-bot-bg: #FFF8E1;
      --nesti-danger: #FF6B6B;
      --nesti-green: #29C48A;
      --nesti-inclusion: #FFF9E7;
      --nesti-task-pending: #B0B8FF;
      --nesti-task-todo: #FDE68A;
      --nesti-task-done: #B9F6CA;
      --font-main: 'Inter', ui-sans-serif, system-ui, sans-serif;
    }
    html, body {margin:0;padding:0; background:var(--nesti-bg); font-family:var(--font-main); color:var(--nesti-text);}
    body, html, #app {min-height:100vh;}
    #app {display:flex; min-height:100vh;}
    .sidebar {
      width:260px; background:var(--nesti-sidebar);
      box-shadow:2px 0 10px rgba(83,176,229,0.08);
      display:flex; flex-direction:column; padding:34px 20px 20px 20px;
      transition:width 0.2s;
    }
    .sidebar-logo {display:flex;align-items:center; margin-bottom:50px;}
    .sidebar-logo svg {width:38px; height:38px; margin-right:12px;}
    .sidebar-title {font-weight:bold;font-size:1.5rem; color:var(--nesti-primary);}
    .sidebar-nav {display:flex; flex-direction:column; gap:14px;}
    .sidebar-nav .nav-item {
      display:flex;align-items:center;gap:13px;
      padding:12px 18px; border-radius:12px; cursor:pointer; font-size:1.13rem; color:var(--nesti-text);
      font-weight:500; transition:background 0.18s;
    }
    .sidebar-nav .nav-item.active, .sidebar-nav .nav-item:focus, .sidebar-nav .nav-item:hover {
      background:var(--nesti-bg); font-weight:700; outline:none;
    }
    .sidebar-profile {
      margin-top:auto; display:flex; align-items:center; gap:10px; padding-top:30px;
    }
    .avatar {width:44px; height:44px; border-radius:50%; background:#EEE; border:2px solid #D9F2FA;}
    .main {flex:1; padding:48px 28px;}
    .dashboard-header {display:flex;justify-content:space-between;align-items:center;}
    .header-info {max-width:60%;}
    .header-title {font-size:2.3rem;font-weight:700;}
    .header-desc {color:var(--nesti-muted);}
    .dashboard-grid {
      display:grid; grid-template-columns:1.1fr 2fr 1.1fr; gap:34px; margin-top:35px;
    }
    .card {
      background:var(--nesti-card); border-radius:19px; box-shadow:0 2px 11px #eaf6fb66; padding:26px 24px 20px 24px; margin-bottom:22px;
      transition:box-shadow 0.17s;
    }
    .card h2, .card h3 {margin-top:0; font-size:1.2rem; font-weight:600;}
    .calendar-table {width:100%; border-collapse:collapse; text-align:center;}
    .calendar-table th, .calendar-table td {padding:6px;}
    .calendar-evt {
      display:flex;align-items:center;margin-top:9px;gap:8px;
      font-size:1em; background:#eaf6fb; border-radius:8px; padding:3px 9px;
    }
    .evt-icon {width:18px;height:18px;}
    .calendar-add-btn {
      background:var(--nesti-primary);color:#fff;border:none; border-radius:7px; font-weight:600;
      padding:4px 13px; cursor:pointer; margin:0 0 9px 0; float:right;
    }
    .calendar-modal-bg {position:fixed; top:0; left:0; width:100vw; height:100vh; background:#0008; z-index:50; display:flex; align-items:center; justify-content:center;}
    .calendar-modal {background:white; border-radius:17px; padding:24px 26px; min-width:330px; box-shadow:0 6px 40px #0002;}
    .calendar-modal label {display:block; margin-top:12px; font-weight:500;}
    .calendar-modal input, .calendar-modal textarea, .calendar-modal select {
      width:95%; font-size:1rem; padding:7px 8px; border-radius:8px; border:1px solid #E0E0E0; margin-top:3px;
    }
    .calendar-modal-actions {display:flex; gap:10px; margin-top:18px;}
    .calendar-modal-actions button {flex:1;}
    .calendar-modal-actions .cancel {background:#f0f0f0;}
    .calendar-modal-actions .save {background:var(--nesti-primary);color:#fff;}
    .calendar-evt .evt-title {font-weight:600;}
    .calendar-evt .evt-time {font-size:0.97em;margin-right:6px;}
    .calendar-evt .evt-note {font-size:0.91em;color:var(--nesti-muted);margin-left:7px;}
    /* Tâches */
    .task-list {margin:0;padding:0;list-style:none;}
    .task-li {display:flex;align-items:center;gap:10px; margin-bottom:9px;}
    .task-checkbox {accent-color:var(--nesti-primary); width:20px;height:20px;}
    .task-title {flex:1;}
    .task-status {font-size:0.92em; border-radius:6px; padding:2px 7px;}
    .status-pending {background:var(--nesti-task-pending);}
    .status-todo {background:var(--nesti-task-todo);}
    .status-done {background:var(--nesti-task-done);}
    .task-add-row {display:flex;gap:7px;margin-top:12px;}
    .task-add-inp {flex:1;}
    .task-add-btn {background:var(--nesti-yellow); border:none; border-radius:8px; padding:7px 13px; font-weight:600; cursor:pointer;}
    .task-assignee {font-size:0.88em;color:var(--nesti-muted);margin-left:7px;}
    /* Chat */
    .chat-list {max-height:195px; overflow-y:auto; margin-bottom:11px;}
    .chat-msg {margin-bottom:11px; padding:10px 14px; border-radius:12px; max-width:70%; font-size:1rem; word-break:break-word;}
    .chat-me {background:var(--nesti-chat-bg); align-self:flex-end;}
    .chat-bot {background:var(--nesti-bot-bg); align-self:flex-start;}
    .chat-row {display:flex;flex-direction:column;align-items:flex-end;}
    .chat-row.bot {align-items:flex-start;}
    .chat-input-row {display:flex;gap:10px;}
    .chat-inp {flex:1; border:1px solid #E0E0E0; border-radius:8px; padding:8px 12px; font-size:1rem;}
    .chat-btn {background:var(--nesti-yellow); color:var(--nesti-text); border:none; border-radius:8px; padding:8px 18px; font-weight:bold; cursor:pointer;}
    /* Activités */
    .activity-card {background:var(--nesti-inclusion); border-radius:12px; padding:13px 18px; margin-bottom:16px;}
    .wellbeing-card {background:var(--nesti-bg); border-radius:12px; padding:14px 18px;}
    .wellbeing-btn {background:var(--nesti-yellow); border:none; border-radius:8px; padding:7px 15px; font-weight:bold; cursor:pointer; margin-top:8px;}
    /* Notifications */
    .notif-banner {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:var(--nesti-green); color:#fff; border-radius:13px;
      padding:12px 20px; font-weight:600; box-shadow:0 4px 24px #1adbb236; z-index:200;
      display:none;
    }
    /* Accessibilité */
    .easyread {font-size:1.3em; letter-spacing:0.03em; background:#fffde8;}
    .easyread .card, .easyread .activity-card, .easyread .wellbeing-card {font-size:1.16em;}
    /* Modal overlay pour charte, privacy, etc */
    .overlay-bg {position:fixed; top:0; left:0; width:100vw; height:100vh; background:#0007; z-index:99; display:flex; align-items:center; justify-content:center;}
    .overlay-content {background:#fff; border-radius:18px; min-width:340px; max-width:95vw; padding:24px 28px; box-shadow:0 8px 40px #0002;}
    .overlay-content h2 {margin-top:0;}
    .overlay-close {background:none; border:none; font-size:1.4em; position:absolute; top:18px; right:23px; cursor:pointer;}
    /* Responsive */
    @media (max-width:1100px) {.dashboard-grid {grid-template-columns:1fr;}}
    @media (max-width:900px) {.main {padding:12px 2vw;}}
    @media (max-width:700px) {
      #app {flex-direction:column;}
      .sidebar {width:100vw; flex-direction:row; padding:10px 8px;}
      .sidebar-logo, .sidebar-profile {display:none;}
      .sidebar-nav {flex-direction:row; gap:10px;}
      .main {padding:10px 3vw;}
    }
  </style>
</head>
<body>
<div id="app"></div>
<div class="notif-banner" id="notif-banner"></div>
<script>
/* ------------------- MOCK DATA & UTILS ------------------- */
const ROLES = ['parent1','parent2','enfant','invite'];
const FAMILIES = [
  {id:1, name:"Famille Demo", members:[
    {id:1, name:"Emma", role:"parent1", email:"emma@mail.com", avatar:"https://www.svgrepo.com/show/427834/avatar-profile.svg"},
    {id:2, name:"Louis", role:"parent2", email:"louis@mail.com", avatar:"https://www.svgrepo.com/show/427839/avatar-profile.svg"},
    {id:3, name:"Alice", role:"enfant", email:"alice@mail.com", avatar:"https://www.svgrepo.com/show/427841/avatar-profile.svg"},
    {id:4, name:"Mamie Jeanne", role:"invite", email:"mamie@mail.com", avatar:"https://www.svgrepo.com/show/427838/avatar-profile.svg"}
  ]}
];
const MOCK_EVENTS = [
  {id:1, title:"Heure du goûter", time:"15:00", day:10, note:"Gâteau au chocolat", creator:1},
  {id:2, title:"Cours de piano", time:"17:00", day:10, note:"Salle 2", creator:2},
  {id:3, title:"Jeux de famille", time:"20:00", day:10, note:"Choisir le jeu", creator:3}
];
const MOCK_TASKS = [
  {id:1, title:"Acheter du pain", status:"À faire", assignee:1},
  {id:2, title:"Préparer le goûter", status:"En cours", assignee:2},
  {id:3, title:"Ranger la chambre", status:"Fait", assignee:3}
];
const MOCK_CHAT = [
  {from:1, text:"Salut à tous! Quelle activité ce soir ?"},
  {from:"bot", text:"Bonjour! Je peux vous suggérer la dernière expo sur l’art thérapie à 1h"},
];
const MOCK_ACTIVITIES = [
  {id:1, title:"Expo sur l’art-thérapie", place:"Musée de l’art moderne", age:"all", tags:["inclusion"]},
  {id:2, title:"Atelier peinture", place:"Centre culturel", age:"8+", tags:["créatif"]},
];
const WELLBEING_MSG = "N’oubliez pas votre pause méditation";

let state = {
  user:null,
  family:null,
  page:"auth", // "dashboard", "calendar", "tasks", "chat", "activities", "settings"
  events:[...MOCK_EVENTS],
  tasks:[...MOCK_TASKS],
  chat:[...MOCK_CHAT],
  easyread:false,
  overlay:null, // {type:'charte'|'privacy'|'event'|'settings', ...}
};

/* ------------------- RENDER ROOT ------------------- */
function renderRoot() {
  document.body.className = state.easyread ? "easyread" : "";
  document.getElementById('app').innerHTML = '';
  if(!state.user) return renderAuth();
  renderApp();
}
window.onhashchange = ()=>{ // Navigation via hash
  const page = location.hash.replace(/^#\/?/,'');
  if(['dashboard','calendar','tasks','chat','activities','settings'].includes(page)) {
    state.page = page;
    renderRoot();
  }
}

/* ------------------- AUTH ------------------- */
function renderAuth() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="margin:auto;max-width:440px;padding:56px 30px 32px 30px;background:var(--nesti-card);border-radius:18px;box-shadow:0 2px 24px #b5e7fd44;">
      <div style="display:flex;align-items:center;margin-bottom:26px;">
        <svg width="44" height="44" viewBox="0 0 40 40"><circle cx="20" cy="20" r="20" fill="#53B0E5"/><ellipse cx="20" cy="22" rx="10" ry="8" fill="#FFE066"/><ellipse cx="19" cy="19" rx="5" ry="3.5" fill="#FFF"/><circle cx="22" cy="19" r="1" fill="#222B45"/><ellipse cx="23" cy="24" rx="3" ry="1" fill="#FFD600"/></svg>
        <span style="font-weight:bold;font-size:2rem;color:var(--nesti-primary);margin-left:14px;">Nesti</span>
      </div>
      <h2 style="margin:0 0 17px 0;">Connectez-vous à votre espace familial</h2>
      <form id="login-form">
        <label style="font-weight:600;">Email</label>
        <input id="login-email" type="email" required placeholder="emma@mail.com" style="width:100%;margin-bottom:17px;padding:9px 11px;border-radius:9px;border:1px solid #e0e0e0;font-size:1.08em;">
        <label style="font-weight:600;">Rôle</label>
        <select id="login-role" style="width:100%;margin-bottom:17px;padding:8px 10px;border-radius:9px;border:1px solid #e0e0e0;font-size:1em;">
          <option value="parent1">Parent 1</option><option value="parent2">Parent 2</option><option value="enfant">Enfant</option><option value="invite">Invité</option>
        </select>
        <button style="background:var(--nesti-primary);color:#fff;width:100%;padding:10px 0;font-weight:bold;border:none;border-radius:9px;font-size:1.15em;cursor:pointer;">Connexion</button>
      </form>
      <div style="margin-top:20px;font-size:0.99em;">
        <a href="#" onclick="showOverlay('charte');return false;" style="color:var(--nesti-primary);">Voir la charte d'inclusion</a>
      </div>
    </div>
  `;
  document.getElementById('login-form').onsubmit = e => {
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim().toLowerCase();
    const role = document.getElementById('login-role').value;
    const family = FAMILIES[0];
    const user = family.members.find(u=>u.email===email && u.role===role) || family.members.find(u=>u.role===role);
    if(user) {
      state.user = user;
      state.family = family;
      state.page = "dashboard";
      location.hash="#/dashboard";
      renderRoot();
    } else {
      showNotif("Email ou rôle incorrects.");
    }
  }
}

/* ------------------- APP SHELL/MAIN ------------------- */
function renderApp() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <aside class="sidebar">
      <div class="sidebar-logo">
        <svg viewBox="0 0 40 40"><circle cx="20" cy="20" r="20" fill="#53B0E5"/><ellipse cx="20" cy="22" rx="10" ry="8" fill="#FFE066"/><ellipse cx="19" cy="19" rx="5" ry="3.5" fill="#FFF"/><circle cx="22" cy="19" r="1" fill="#222B45"/><ellipse cx="23" cy="24" rx="3" ry="1" fill="#FFD600"/></svg>
        <span class="sidebar-title">Nesti</span>
      </div>
      <nav class="sidebar-nav">
        ${navItem("dashboard","Dashboard","M17 6V3M7 6V3M3 9h18M4 19h16a1 1 0 001-1V7a1 1 0 00-1-1H4a1 1 0 00-1 1v11a1 1 0 001 1z")}
        ${navItem("calendar","Calendrier","M8 7V3m8 4V3m-9 8h18M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z")}
        ${navItem("tasks","Tâches","M9 12l2 2l4-4m-7 8h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v7a2 2 0 002 2z")}
        ${navItem("chat","Chat","M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z")}
        ${navItem("activities","Activités","M12 8c-1.657 0-3 1.343-3 3c0 1.657 1.343 3 3 3s3-1.343 3-3c0-1.657-1.343-3-3-3zm0 8c-2.21 0-4-1.79-4-4a4 4 0 118 0c0 2.21-1.79 4-4 4zm7-2h5M17 7v14m-2-7h4")}
        ${navItem("settings","Paramètres","M12 8c-1.657 0-3 1.343-3 3c0 1.657 1.343 3 3 3s3-1.343 3-3c0-1.657-1.343-3-3-3zm0 8c-2.21 0-4-1.79-4-4a4 4 0 118 0c0 2.21-1.79 4-4 4zm7-2h5M17 7v14m-2-7h4")}
      </nav>
      <div class="sidebar-profile">
        <img class="avatar" src="${state.user.avatar}" />
        <div style="font-size:0.97em;">
          <div style="font-weight:600;">${state.user.name}</div>
          <div style="color:var(--nesti-muted);">${roleLabel(state.user.role)}</div>
        </div>
        <button onclick="logout()" style="margin-left:auto;background:none;border:none;color:var(--nesti-primary);font-size:1.2em;cursor:pointer;" title="Déconnexion">&rarr;</button>
      </div>
    </aside>
    <main class="main" id="main-container"></main>
  `;
  // Navigation
  Array.from(document.querySelectorAll('.nav-item')).forEach(item=>{
    item.onclick = ()=>{location.hash="#/"+item.dataset.page;}
  });
  // Page content
  renderPageContent();
}
function navItem(page,label,iconPath) {
  const active = state.page===page ? "active" : "";
  return `<div class="nav-item ${active}" data-page="${page}" tabindex="0">
    <svg class="evt-icon" viewBox="0 0 24 24" fill="none" stroke="#53B0E5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${iconPath}"/></svg>
    <span>${label}</span>
  </div>`;
}
function roleLabel(r) {
  return {parent1:"Parent 1",parent2:"Parent 2",enfant:"Enfant",invite:"Invité"}[r]||r;
}
function logout(){ state.user=null; state.family=null; state.page="auth"; location.hash=''; renderRoot(); }

/* ------------------- PAGES ------------------- */
function renderPageContent() {
  let html = "";
  switch(state.page) {
    case "dashboard": html = dashboardPage(); break;
    case "calendar": html = calendarPage(); break;
    case "tasks": html = tasksPage(); break;
    case "chat": html = chatPage(); break;
    case "activities": html = activitiesPage(); break;
    case "settings": html = settingsPage(); break;
    default: html = dashboardPage();
  }
  document.getElementById('main-container').innerHTML = html;
  // Bind page interactions
  afterRenderPage();
}
function dashboardPage() {
  return `
    <div class="dashboard-header">
      <div class="header-info">
        <div class="header-title">Bonjour, ${state.user.name}</div>
        <div class="header-desc">Organisation et bien-être pour toute la famille</div>
      </div>
      <img class="avatar" src="${state.user.avatar}" />
    </div>
    <div class="dashboard-grid">
      <section class="card">
        <h2>Emploi du temps</h2>
        <button class="calendar-add-btn" onclick="showOverlay('event')">+</button>
        ${calendarMiniTable()}
        ${state.events.filter(e=>e.day===10).map(evt=>calendarEventLine(evt)).join('')}
      </section>
      <section class="card" style="grid-column: span 2;">
        <h2>Chat familial</h2>
        <div id="chat-list" class="chat-list"></div>
        <form class="chat-input-row" id="chat-form" autocomplete="off">
          <input id="chat-input" class="chat-inp" placeholder="Écrire un message..." />
          <button type="submit" class="chat-btn">Envoyer</button>
          <button type="button" class="chat-btn" id="rephrase-btn" title="Reformuler (IA)">🤖</button>
        </form>
      </section>
      <div>
        <div class="activity-card">
          <h3 style="margin:0 0 5px 0;">Activités inclusives</h3>
          <div style="font-weight:600;">${MOCK_ACTIVITIES[0].title}</div>
          <div style="color:#888;font-size:0.98em;">${MOCK_ACTIVITIES[0].place}</div>
        </div>
        <div class="wellbeing-card">
          <h3 style="margin:0 0 5px 0;">Votre bien-être</h3>
          <div>${WELLBEING_MSG}</div>
          <button class="wellbeing-btn" onclick="showNotif('Bonne méditation !')">Démarrer</button>
        </div>
      </div>
    </div>
  `;
}
function calendarPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
      <h2 style="font-size:2em;font-weight:700;">Calendrier familial</h2>
      <button class="calendar-add-btn" onclick="showOverlay('event')">Ajouter un événement</button>
    </div>
    <div>
      <table class="calendar-table"><thead>
        <tr><th>Date</th><th>Heure</th><th>Événement</th><th>Note</th><th>Ajouté par</th></tr>
      </thead><tbody>
        ${state.events.map(evt=>`
          <tr>
            <td>${evt.day}/09</td>
            <td>${evt.time}</td>
            <td>${evt.title}</td>
            <td>${evt.note||""}</td>
            <td>${userName(evt.creator)}</td>
          </tr>
        `).join('')}
      </tbody></table>
    </div>
  `;
}
function tasksPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;">
      <h2 style="font-size:2em;font-weight:700;">Liste de tâches</h2>
    </div>
    <ul class="task-list">
      ${state.tasks.map(t=>`
        <li class="task-li">
          <input class="task-checkbox" type="checkbox" ${t.status==="Fait"?"checked":""} onchange="toggleTaskStatus(${t.id})"/>
          <span class="task-title">${t.title}</span>
          <span class="task-status ${statusClass(t.status)}">${t.status}</span>
          <span class="task-assignee">${userName(t.assignee)}</span>
          <button onclick="deleteTask(${t.id})" style="background:none;border:none;color:var(--nesti-danger);font-size:1.2em;cursor:pointer;">×</button>
        </li>
      `).join('')}
    </ul>
    <div class="task-add-row">
      <input id="task-add-inp" class="task-add-inp" placeholder="Nouvelle tâche à ajouter..." />
      <select id="task-add-user">
        ${state.family.members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('')}
      </select>
      <button class="task-add-btn" onclick="addTask()">Ajouter</button>
    </div>
  `;
}
function chatPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;">
      <h2 style="font-size:2em;font-weight:700;">Chat familial</h2>
    </div>
    <div id="chat-list" class="chat-list"></div>
    <form class="chat-input-row" id="chat-form" autocomplete="off">
      <input id="chat-input" class="chat-inp" placeholder="Écrire un message..." />
      <button type="submit" class="chat-btn">Envoyer</button>
      <button type="button" class="chat-btn" id="rephrase-btn" title="Reformuler (IA)">🤖</button>
    </form>
  `;
}
function activitiesPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;">
      <h2 style="font-size:2em;font-weight:700;">Activités inclusives & recommandations</h2>
      <button onclick="showOverlay('charte')" style="background:var(--nesti-yellow);border:none;padding:8px 19px;border-radius:8px;font-weight:bold;cursor:pointer;">Charte inclusion</button>
    </div>
    <div>
      ${MOCK_ACTIVITIES.map(a=>`
        <div class="activity-card">
          <div style="font-size:1.08em;font-weight:bold;">${a.title}</div>
          <div style="color:#888;font-size:0.98em;">${a.place}</div>
          <div style="color:#6B7280;font-size:0.97em;margin-top:7px;">Tags: ${a.tags.join(', ')}</div>
        </div>
      `).join('')}
    </div>
  `;
}
function settingsPage() {
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;">
      <h2 style="font-size:2em;font-weight:700;">Paramètres</h2>
    </div>
    <div class="card" style="margin-bottom:19px;">
      <label style="display:flex;align-items:center;gap:12px;font-size:1.18em;">
        <input type="checkbox" id="easyread-toggle" ${state.easyread?"checked":""} onchange="toggleEasyRead()" />
        Activer le mode « lecture facile » (accessibilité)
      </label>
    </div>
    <div class="card">
      <h3>Confidentialité et données</h3>
      <button onclick="showOverlay('privacy')" style="background:var(--nesti-primary);color:#fff;font-size:1.06em;border:none;padding:8px 19px;border-radius:8px;font-weight:bold;cursor:pointer;">Voir la politique</button>
      <button onclick="showNotif('Données exportées (démo)')" style="margin-left:18px;background:var(--nesti-yellow);border:none;padding:8px 19px;border-radius:8px;font-weight:bold;cursor:pointer;">Exporter mes données</button>
      <button onclick="showNotif('Suppression demandée (démo)')" style="margin-left:18px;background:#f0b6b6;color:#fff;border:none;padding:8px 19px;border-radius:8px;font-weight:bold;cursor:pointer;">Demander suppression</button>
    </div>
  `;
}
/* Dashboard calendar mini-table */
function calendarMiniTable() {
  return `
    <table class="calendar-table">
      <thead><tr><th>L</th><th>M</th><th>M</th><th>J</th><th>V</th><th>S</th><th>D</th></tr></thead>
      <tbody>
        <tr>
          <td>9</td><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td>
        </tr>
      </tbody>
    </table>
  `;
}
function calendarEventLine(evt) {
  return `<div class="calendar-evt">
    <svg class="evt-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="4" fill="#53B0E5"/></svg>
    <span class="evt-time">${evt.time}</span>
    <span class="evt-title">${evt.title}</span>
    <span class="evt-note">${evt.note||""}</span>
  </div>`;
}
function userName(id) {
  const m = state.family.members.find(m=>m.id===id); return m?m.name:"";
}
function statusClass(st) {
  if(st==="En cours") return "status-pending";
  if(st==="À faire") return "status-todo";
  if(st==="Fait") return "status-done";
  return "";
}
/* ------------------- AFTER RENDER: BINDINGS ------------------- */
function afterRenderPage() {
  // Chat
  if(["dashboard","chat"].includes(state.page)) renderChat();
  // Chat submit
  const chatForm = document.getElementById('chat-form');
  if(chatForm) {
    chatForm.onsubmit = e => {
      e.preventDefault();
      const inp = document.getElementById('chat-input');
      const txt = inp.value.trim();
      if(txt){
        state.chat.push({from:state.user.id, text:txt});
        renderChat();
        inp.value = "";
      }
    }
    document.getElementById('rephrase-btn').onclick = function(){
      const inp = document.getElementById('chat-input');
      if(inp.value.trim()){
        // Reformulation naïve :
        let txt = inp.value.replace(/(pas|non|nul|bête|fâché|problème|difficile|jamais|impossible|trop)/gi, "un peu compliqué");
        if(!txt.match(/(merci|bravo|chouette|génial|super|content|heureux)/i)){
          txt = "Merci pour ta participation ! " + txt;
        }
        inp.value = txt;
      }
    };
  }
}
/* Chat render */
function renderChat() {
  const chatList = document.getElementById('chat-list');
  if(!chatList) return;
  chatList.innerHTML = "";
  state.chat.forEach(msg => {
    const row = document.createElement("div");
    row.className = "chat-row " + (msg.from === "bot" ? "bot" : "");
    const bubble = document.createElement("div");
    bubble.className = "chat-msg " + (msg.from === "bot" ? "chat-bot" : "chat-me");
    if(msg.from === "bot"){
      bubble.innerHTML = '<svg style="width:18px;height:18px;vertical-align:middle;margin-right:7px;" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#FFE066"/><ellipse cx="16" cy="13" rx="7" ry="5" fill="#FFF"/><ellipse cx="16" cy="22" rx="9" ry="6" fill="#FFFDE7"/><circle cx="14" cy="13" r="1" fill="#222B45"/><circle cx="18" cy="13" r="1" fill="#222B45"/><rect x="13" y="18" width="6" height="2" rx="1" fill="#FFD600"/></svg>' + msg.text;
    }else{
      bubble.textContent = msg.text;
    }
    row.appendChild(bubble);
    chatList.appendChild(row);
  });
  chatList.scrollTop = chatList.scrollHeight;
}
/* ------------------- TÂCHES ------------------- */
function toggleTaskStatus(id) {
  const t = state.tasks.find(t=>t.id===id);
  if(t) t.status = t.status==="Fait"?"À faire":"Fait";
  renderPageContent();
}
function deleteTask(id) {
  state.tasks = state.tasks.filter(t=>t.id!==id);
  renderPageContent();
}
function addTask() {
  const inp = document.getElementById('task-add-inp');
  const uid = +document.getElementById('task-add-user').value;
  if(inp.value.trim()) {
    state.tasks.push({id:Date.now(), title:inp.value, status:"À faire", assignee:uid});
    inp.value = "";
    renderPageContent();
  }
}
/* ------------------- OVERLAY & MODALS ------------------- */
function showOverlay(type) {
  state.overlay = {type};
  renderOverlay();
}
function closeOverlay() {
  state.overlay = null;
  document.getElementById("overlay-root")?.remove();
}
function renderOverlay() {
  const existing = document.getElementById("overlay-root");
  if(existing) existing.remove();
  const div = document.createElement("div");
  div.id = "overlay-root";
  div.className = "overlay-bg";
  let html = "";
  if(state.overlay.type==="charte") {
    html = `<div class="overlay-content" style="position:relative;">
      <button class="overlay-close" onclick="closeOverlay()">&times;</button>
      <h2>Charte d’inclusion</h2>
      <ul>
        <li><b>Respect</b> des différences et des besoins de chacun</li>
        <li><b>Équité</b> dans les échanges et la répartition des tâches</li>
        <li><b>Accessibilité</b> pour tous : design et contenus adaptés</li>
        <li><b>Bienveillance</b> dans la communication (IA de reformulation, modération)</li>
        <li>Signalement simple, comité de revue transparent</li>
      </ul>
      <div style="font-size:0.96em;color:var(--nesti-muted);margin-top:15px;">En utilisant Nesti, vous acceptez ces valeurs.</div>
    </div>`;
  }
  if(state.overlay.type==="privacy") {
    html = `<div class="overlay-content" style="position:relative;">
      <button class="overlay-close" onclick="closeOverlay()">&times;</button>
      <h2>Politique de confidentialité</h2>
      <ul>
        <li>Données limitées au strict nécessaire (RGPD ready)</li>
        <li>Chiffrement en transit et au repos</li>
        <li>Droit d'accès, de portabilité, de suppression à tout moment</li>
        <li>Consentement explicite pour localisation, santé, photos</li>
        <li>Prompts IA anonymisés, pas de profilage</li>
      </ul>
      <div style="font-size:0.96em;color:var(--nesti-muted);margin-top:15px;">Contact DPO: privacy@nesti-app.fr</div>
    </div>`;
  }
  if(state.overlay.type==="event") {
    html = `<div class="calendar-modal">
      <h3>Nouvel événement</h3>
      <form id="event-form">
        <label>Titre</label>
        <input id="event-title" required />
        <label>Heure</label>
        <input id="event-time" type="time" required />
        <label>Jour (septembre)</label>
        <input id="event-day" type="number" min="1" max="30" required />
        <label>Note (optionnelle)</label>
        <input id="event-note" />
        <div class="calendar-modal-actions">
          <button class="cancel" type="button" onclick="closeOverlay()">Annuler</button>
          <button class="save" type="submit">Ajouter</button>
        </div>
      </form>
    </div>`;
  }
  div.innerHTML = html;
  document.body.appendChild(div);
  if(state.overlay.type==="event") {
    document.getElementById("event-form").onsubmit = function(e){
      e.preventDefault();
      const title = document.getElementById("event-title").value.trim();
      const time = document.getElementById("event-time").value;
      const day = +document.getElementById("event-day").value;
      const note = document.getElementById("event-note").value.trim();
      if(title && time && day) {
        state.events.push({id:Date.now(), title, time, day, note, creator:state.user.id});
        closeOverlay();
        renderPageContent();
        showNotif("Événement ajouté !");
      }
    }
  }
}
/* ------------------- NOTIFICATIONS ------------------- */
function showNotif(msg) {
  const banner = document.getElementById("notif-banner");
  if(!banner) return;
  banner.textContent = msg;
  banner.style.display = "block";
  setTimeout(()=>{banner.style.display="none";},2200);
}
/* ------------------- ACCESSIBILITÉ ------------------- */
function toggleEasyRead() {
  state.easyread = !state.easyread;
  renderRoot();
}
/* ------------------- INIT ------------------- */
renderRoot();
</script>
</body>
</html>
